@using Vista.Data.Models.Grupos.FuerzasIntervinientes
@using Vista.Data.ViewModels
@using Vista.Data.ViewModels.Personal
@using Vista.Data.Models.Vehiculos.Flota
@using Vista.Data.Models.Personas.Personal
@using Vista.Data.Mappers
@using Vista.Data.Models.Salidas.Componentes

@*Servicios Utilizados*@
@using Vista.Services
@inject IMessageService MessageService
@inject IFuerzaIntervinienteService FuerzaIntervinienteService

<style>
    .fuerzas-intervinientes {
        border: 2px solid #e53935 !important;
        background: linear-gradient(180deg, #fff5f5 0%, #ffeaea 100%) !important;
        box-shadow: 0 4px 12px rgba(229, 57, 53, 0.15) !important;
        border-radius: 16px !important;
        margin-bottom: 2rem !important;
        padding: 2.5rem 2rem 2rem 2rem !important;
        transition: box-shadow 0.25s ease, transform 0.2s ease !important;
    }

        .fuerzas-intervinientes .section-number {
            background: linear-gradient(135deg, #b71c1c, #e53935);
            color: white;
        }

        .fuerzas-intervinientes .ant-table {
            background: #fff5f5 !important;
            color: #b71c1c !important;
            font-weight: 500 !important;
            font-size: 1.05rem !important;
            border-radius: 14px !important;
            min-width: 600px !important;
            width: 100% !important;
            table-layout: auto !important;
        }

            .fuerzas-intervinientes .ant-table-thead .ant-table-cell,
            .fuerzas-intervinientes .ant-table thead th {
                background: linear-gradient(135deg, #ff6b6b, #c62828) !important;
                border-right: 1px solid #ffcdd2 !important;
                color: #fff !important;
                font-weight: 700 !important;
                text-align: center !important;
                border-bottom: 2.5px solid #ffcdd2 !important;
                letter-spacing: 0.3px !important;
                font-size: 1.08rem !important;
                padding: 8px 10px !important;
                height: 32px !important;
            }

        .fuerzas-intervinientes .ant-table-title {
            background: #fff5f5 !important;
            color: #b71c1c !important;
            font-weight: 700 !important;
            font-size: 1.08rem !important;
            text-align: left !important;
            padding: 0.5rem 0.8rem !important;
            border-top-left-radius: 12px !important;
            border-top-right-radius: 12px !important;
            border-bottom: 1px solid #ffcdd2 !important;
        }

        .fuerzas-intervinientes .ant-table-cell,
        .fuerzas-intervinientes .ant-table td {
            background: #fff !important;
            border-right: 1px solid #f5b5b5 !important;
            color: #333 !important;
            font-size: 1rem !important;
            padding: 6px 10px !important;
            height: 28px !important;
        }

        .fuerzas-intervinientes .ant-table tbody tr:hover td {
            background: #fff0f0 !important;
        }

        .fuerzas-intervinientes .ant-btn-dangerous,
        .fuerzas-intervinientes .ant-btn[Danger] {
            background: linear-gradient(135deg, #ff6b6b, #c62828) !important;
            border: none !important;
            color: #fff !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 8px rgba(229,57,53,.18) !important;
            transition: all 0.2s ease-in-out !important;
            font-size: 0.95rem !important;
            padding: 4px 10px !important;
        }

            .fuerzas-intervinientes .ant-btn-dangerous:hover {
                filter: brightness(1.1) !important;
                transform: scale(1.05) !important;
            }

        .fuerzas-intervinientes .ant-table-tbody > tr.ant-table-row-selected > td {
            background: #ffeaea !important;
        }

        .fuerzas-intervinientes .centrado {
            display: flex !important;
            justify-content: flex-end !important;
        }
</style>

<div class="fuerzas-intervinientes">
    <Form Model="fuerzaForm">
        <div style="margin-bottom: 24px;">
            <div style="border-bottom: 2px solid #e53935; padding-bottom: 8px; margin-bottom: 16px;">
                <h4 style="color: #e53935; margin: 0; font-weight: 600;">Fuerza Interviniente</h4>
            </div>
            <Row Gutter="16">
                <AntDesign.Col Xs="24" Sm="12" Md="12" Lg="12">
                    <FormItem Label="Fuerza Interviniente" Required>
                        <Select TItem="SimpleFuerzaViewModel"
                                TItemValue="SimpleFuerzaViewModel"
                                DataSource="@FuerzasIntervinientesList"
                                @bind-Value="fuerzaForm.FuerzaViewModel"
                                LabelName="@nameof(SimpleFuerzaViewModel.Nombre)"
                                DefaultActiveFirstOption
                                AllowClear
                                EnableSearch>
                        </Select>
                    </FormItem>
                </AntDesign.Col>
                <AntDesign.Col Xs="24" Sm="12" Md="12" Lg="12">
                    <FormItem Label="N° Unidad" Required>
                        <Input @bind-Value="fuerzaForm.NumeroUnidad" Placeholder="Ingrese el número de unidad" />
                    </FormItem>
                </AntDesign.Col>
            </Row>
            <Row Gutter="16">
                <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="8">
                    <FormItem Label="Encargado" Required>
                        <Input @bind-Value="fuerzaForm.EncargadoApellidoyNombre" Placeholder="Nombre del encargado" />
                    </FormItem>
                </AntDesign.Col>
            </Row>
            <Row Justify="RowJustify.End" style="margin-top: 16px;">
                <AntDesign.Col>
                    <Button Type="@ButtonType.Primary"
                            OnClick="@CargarFuerza"
                            Icon="plus"
                            Style="background-color: #e53935; border-color: #e53935;">
                        Cargar Fuerza Interviniente
                    </Button>
                </AntDesign.Col>
            </Row>
        </div>
    </Form>

    @* Tabla de Fuerzas Intervinientes Cargadas *@
    @if (Model.FuerzasIntervinientes.Any())
    {
        <div style="margin-top: 32px;">
            <div style="border-bottom: 2px solid #e53935; padding-bottom: 8px; margin-bottom: 16px;">
                <h4 style="color: #e53935; margin: 0; font-weight: 600; display: flex; align-items: center;">
                    <Icon Type="team" style="margin-right: 8px;" />
                    Fuerzas Intervinientes Asignadas
                    <Badge Count="@Model.FuerzasIntervinientes.Count"
                           Style="margin-left: 12px; background-color: #e53935;" />
                </h4>
            </div>
            <div style="overflow-x: auto;">
                <Table TItem="FuerzaIntervinienteViewModel"
                       DataSource="@Model.FuerzasIntervinientes"
                       Responsive>
                    <ColumnDefinitions Context="item">
                        <PropertyColumn Title="Encargado"
                                        Property="f => f.EncargadoApellidoyNombre"
                                        Align="ColumnAlign.Center">
                        </PropertyColumn>
                        <PropertyColumn Title="N° Unidad"
                                        Property="f => f.NumeroUnidad"
                                        Align="ColumnAlign.Center">
                        </PropertyColumn>
                        <PropertyColumn Title="Fuerza"
                                        Property="f => f.FuerzaViewModel.Nombre"
                                        Align="ColumnAlign.Center">
                        </PropertyColumn>
                        <ActionColumn Title="Acciones" Align="ColumnAlign.Center">
                            <Button Type="@ButtonType.Text"
                                    Danger
                                    Size="@ButtonSize.Large"
                                    Icon="delete"
                                    Style="font-size: 0.95rem; padding: 4px 10px;"
                                    OnClick="@(() => EliminarFuerza(item))">
                            </Button>
                        </ActionColumn>
                    </ColumnDefinitions>
                </Table>
            </div>
        </div>
    }
</div>



@code {
    [Parameter, EditorRequired] public SalidasViewModels Model { get; set; } = null!;
    public bool IsFormDisabled { get; set; }
    private FuerzaIntervinienteViewModel fuerzaForm = new();
    private bool _isLoading = true;
    private List<SimpleFuerzaViewModel> FuerzasIntervinientesList { get; set; } = new();

    private async Task CargarFuerza()
    {
        if (fuerzaForm.FuerzaViewModel.Id <= 0 ||
            string.IsNullOrWhiteSpace(fuerzaForm.NumeroUnidad) ||
            string.IsNullOrWhiteSpace(fuerzaForm.EncargadoApellidoyNombre))
        {
            await MessageService.ErrorAsync("Por favor, complete todos los campos requeridos.");
            return;
        }

        // Verificar si ya existe la combinación completa (fuerza + unidad + encargado)
        bool duplicado = Model.FuerzasIntervinientes.Any(f =>
            f.FuerzaViewModel.Id == fuerzaForm.FuerzaViewModel.Id &&
            f.NumeroUnidad == fuerzaForm.NumeroUnidad &&
            f.EncargadoApellidoyNombre == fuerzaForm.EncargadoApellidoyNombre);

        if (duplicado)
        {
            await MessageService.WarningAsync("Esta fuerza, unidad y encargado ya han sido agregadas.");
            return;
        }

        // Verificar si ya existe el mismo número de unidad para la misma fuerza
        bool unidadRepetida = Model.FuerzasIntervinientes.Any(f =>
            f.FuerzaViewModel.Id == fuerzaForm.FuerzaViewModel.Id &&
            f.NumeroUnidad == fuerzaForm.NumeroUnidad);

        if (unidadRepetida)
        {
            await MessageService.WarningAsync("El número de unidad ya existe para esta fuerza.");
            return;
        }

        Model.FuerzasIntervinientes.Add(fuerzaForm);

        fuerzaForm = new(); // Reinicia el formulario
        await MessageService.SuccessAsync("Fuerza interviniente agregada.");
        StateHasChanged();
    }

    private async Task EliminarFuerza(FuerzaIntervinienteViewModel fuerza)
    {
        try
        {
            Model.FuerzasIntervinientes.Remove(fuerza);
            await MessageService.SuccessAsync("Fuerza interviniente eliminada");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MessageService.ErrorAsync($"Error al eliminar fuerza: {ex.Message}");
        }
    }

    private async Task<List<SimpleFuerzaViewModel>> LoadFuerzasIntervinientesAsync()
    {
        var fuerzas = await FuerzaIntervinienteService.ObtenerTodasLasFuerzasAsync();

        return fuerzas.Select(f => new SimpleFuerzaViewModel
        {
            Id = f.Id,
            Nombre = f.NombreFuerza!
        }).ToList();

    }

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;

        try
        {
            FuerzasIntervinientesList = await LoadFuerzasIntervinientesAsync();
        }
        catch (Exception ex)
        {
            await MessageService.ErrorAsync($"Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}