@using System.Timers
@using System.Web
@using Vista.DTOs.Nominatim
@using Vista.Data.Enums.Salidas
@using Vista.Data.ViewModels
@using Vista.Data.Models.Grupos.FuerzasIntervinientes

@*Servicios Utilizados*@
@using Vista.Services
@inject INominatimService GeorefService
@inject IFuerzaIntervinienteService FuerzaIntervinienteService
@inject IMessageService MessageService
@implements IDisposable

<style>

    .map-container {
        width: 300px;
        height: 300px;
        border: 1px solid #ccc;
        border-radius: 6px;
        overflow: hidden;
        margin: 20px auto;
    }

    @@media screen and (max-width: 450px) {
        .map-container {
            width: 100%;
            height: auto;
        }
    }

    .datos-generales {
        border: 2px solid #40a9ff;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(24,144,255,0.08);
        padding: 2.5rem 2rem 2rem 2rem;
        margin-bottom: 2rem;
        transition: box-shadow 0.2s;
    }

        .datos-generales .section-title {
            color: #1890ff;
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }

    .hora-row {
        display: flex;
        gap: 24px;
        align-items: flex-end;
        margin-bottom: 16px;
    }

        .hora-row .ant-form-item {
            margin-bottom: 0;
            min-width: 180px;
        }
</style>

<div class="datos-generales">
    <Form Model="Model"
          ValidateOnChange="@true"
          Loading="_formloading">

        @* 🕒 Información Temporal *@
        <div style="margin-bottom: 24px;">
            <div style="border-bottom: 2px solid #1890ff; padding-bottom: 8px; margin-bottom: 16px;">
                <h4 style="color: #1890ff; margin: 0; font-weight: 600;">🕒 Información Temporal</h4>
            </div>
            @if (Model.TimeLlegada < Model.TimeSalida)
            {
                <FormItem Label="Fechas" Required>
                    <RangePicker TValue="DateTime[]" Disabled="new bool[] { false, true }"
                                 @bind-Value="@FechaRange" />
                </FormItem>
            }
            else
            {
                <FormItem Label="Fecha" Required>
                    <DatePicker TValue="DateTime" Picker="@DatePickerType.Date" @bind-Value="@Model.FechaSalida" />
                </FormItem>
            }

            <div class="hora-row">
                <FormItem Label="Hora Salida" Required>
                    <TimePicker @bind-Value="@Model.TimeSalida" Format="HH:mm" />
                </FormItem>
                <FormItem Label="Hora Llegada" Required>
                    <TimePicker @bind-Value="@Model.TimeLlegada" Format="HH:mm" />
                </FormItem>
            </div>
        </div>

        @* 📍 Ubicación *@
        <div style="margin-bottom: 14px;">
            <div style="border-bottom: 2px solid #1890ff; padding-bottom: 4px; margin-bottom: 8px;">
                <h4 style="color: #1890ff; margin: 0; font-weight: 600; font-size: 1.08rem;">📍 Ubicación</h4>
            </div>

            @if (isApiAvailable)
            {
                <Row Gutter="24">
                    <AntDesign.Col Span="24">
                        <FormItem Label="Dirección" Required>
                            <Select TItem="Direccion"
                                    TItemValue="Direccion"
                                    DataSource="@direcciones"
                                    @bind-Value="@DireccionSelecionada"
                                    Placeholder="Ingrese una direccion o coordenadas"
                                    LabelName="@nameof(Direccion.Descripcion)"
                                    OnSearch="OnSearch"
                                    SearchDebounceMilliseconds="350"
                                    EnableSearch
                                    Loading="@_loading"
                                    OnSelectedItemChanged="OnStreetSelected">
                            </Select>
                        </FormItem>
                    </AntDesign.Col>
                </Row>
            }

            <Row Gutter="16">
                <AntDesign.Col Span="12">
                    <FormItem Label="Tipo Zona" Required>
                        <EnumSelect TEnum="TipoZona ?" @bind-Value="@Model.TipoZona" />
                    </FormItem>
                </AntDesign.Col>
                <AntDesign.Col Span="12">
                    <FormItem Label="Región Cuartel" Required>
                        <EnumSelect TEnum="CuartelRegionChivilcoy ?" @bind-Value="@Model.CuartelRegion" DefaultActiveFirstOption="false" />
                    </FormItem>
                </AntDesign.Col>
            </Row>

            @if (Model.Latitud.HasValue && Model.Longitud.HasValue)
            {
                <div class="map-container">
                    <iframe style="border:0; width: 100%; aspect-ratio: 1 / 1;"
                            src="@GetGoogleMapsSatelliteUrl(Model.Latitud.Value, Model.Longitud.Value)"
                            frameborder="0"
                            allowfullscreen>
                    </iframe>
                </div>
            }
        </div>

        @* 🏢 Detalles del Lugar *@
        @if (MostrarOpcionDepartamento)
        {
            <div style="margin-bottom: 24px;">
                <div style="border-bottom: 2px solid #1890ff; padding-bottom: 8px; margin-bottom: 16px;">
                    <h4 style="color: #1890ff; margin: 0; font-weight: 600;">🏢 Detalles del Lugar</h4>
                </div>
                <FormItem Label="¿Es Departamento?">
                    <Switch @bind-Checked="@esDepartamento" />
                </FormItem>

                @if (esDepartamento)
                {
                    <Row Gutter="16">
                        <AntDesign.Col Span="12">
                            <FormItem Label="Piso">
                                <Input @bind-Value="@Model.PisoNumero" Placeholder="Número de piso" />
                            </FormItem>
                        </AntDesign.Col>
                        <AntDesign.Col Span="12">
                            <FormItem Label="Departamento">
                                <Input @bind-Value="@Model.Depto" Placeholder="Nro. de depto." />
                            </FormItem>
                        </AntDesign.Col>
                    </Row>
                }
            </div>
        }

        @* 🚒 Información Operativa *@
        <div style="margin-bottom: 24px;">
            <div style="border-bottom: 2px solid #1890ff; padding-bottom: 8px; margin-bottom: 16px;">
                <h4 style="color: #1890ff; margin: 0; font-weight: 600;">🚒 Información Operativa</h4>
            </div>

            <FormItem Label="¿Se convoca Guardia?">
                <Switch @bind-Checked="@SeConvocoGuardia" />
            </FormItem>

            @if (SeConvocoGuardia)
            {
                <FormItem Label="Guardia">
                    <EnumSelect TEnum="Guardia ?" @bind-Value="@Model.GuardiaSelecionada" />
                </FormItem>
            }
        </div>

        @* Detalles o Daños Generales *@
        <div style="margin-bottom: 24px;">
            <div style="border-bottom: 2px solid #1890ff; padding-bottom: 8px; margin-bottom: 16px;">
                <h4 style="color: #1890ff; margin: 0; font-weight: 600;">Detalles o Daños Generales</h4>
            </div>
            <FormItem Required>
                <TextArea Placeholder="Describa la situación o evento..."
                          @bind-Value="@Model.Descripcion"
                          Rows="4" />
            </FormItem>
        </div>

    </Form>
</div>

@code {
    [Parameter, EditorRequired] public required SalidasViewModels Model { get; set; } // Modelo de datos para el formulario
    [Parameter] public bool IsFormDisabled { get; set; }
    [Parameter] public bool MostrarOpcionDepartamento { get; set; } = true; // Indica si se muestra la opción de departamento (En algunos casos es imposible que sea un deparatamento)

    private bool isApiAvailable;

    private bool _loading = false; // Variable para controlar el estado de carga
    private bool _formloading = true;

    private bool esDepartamento;
    private bool SeConvocoGuardia;
    private bool IntervencionDeFuerzasIntervinientes;

    private Direccion DireccionSelecionada = new();

    private List<Direccion> direcciones = new();

    private CancellationTokenSource? _searchCancellationTokenSource;

    protected override async Task OnInitializedAsync()
    {
        _formloading = true;

        try
        {
            isApiAvailable = await GeorefService.CheckApiConnectionAsync();

            if (Model != null)
            {
                if (Model.FechaSalida == DateTime.MinValue)
                {
                    Model.FechaSalida = DateTime.Today;
                }

                esDepartamento = !string.IsNullOrEmpty(Model.PisoNumero) ||
                                        !string.IsNullOrEmpty(Model.Depto);

                // Activa el switch si ya se había convocado una guardia
                SeConvocoGuardia = Model.GuardiaSelecionada != default(Guardia);
            }
        }
        catch (Exception ex)
        {
            await MessageService.ErrorAsync($"Error: {ex.Message}");
        }
        finally
        {
            _formloading = false;
            StateHasChanged();
        }
    }

    private void OnStreetSelected(Direccion selectedStreet)
    {
        if (selectedStreet != null)
        {
            Model.Direccion = selectedStreet.Descripcion;
            Model.Latitud = selectedStreet.Lat;
            Model.Longitud = selectedStreet.Lon;
            StateHasChanged();
        }
    }

    private void OnSearch(string value)
    {
        // Ejecutar la búsqueda en segundo plano sin bloquear la UI
        _ = PerformSearchAsync(value);
    }

    private async Task PerformSearchAsync(string value)
    {
        // Cancelar búsqueda anterior si existe
        _searchCancellationTokenSource?.Cancel();
        _searchCancellationTokenSource?.Dispose();
        _searchCancellationTokenSource = new CancellationTokenSource();
        var cancellationToken = _searchCancellationTokenSource.Token;

        // Validar longitud mínima
        if (string.IsNullOrWhiteSpace(value) || value.Length < 3)
        {
            direcciones.Clear();
            _loading = false;
            await InvokeAsync(StateHasChanged);
            return;
        }

        // Si la API no está disponible, no intentar buscar
        if (!isApiAvailable)
        {
            await MessageService.WarningAsync("La API de búsqueda de direcciones no está disponible.");
            return;
        }

        _loading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            // Realizar la búsqueda
            direcciones = await GeorefService.GetSuggestionsAsync(value);

            // Si la tarea fue cancelada, no actualizar
            if (cancellationToken.IsCancellationRequested)
            {
                return;
            }
        }
        catch (OperationCanceledException)
        {
            // Búsqueda cancelada, no hacer nada
            return;
        }
        catch (Exception ex)
        {
            // Solo mostrar el error si no fue cancelado
            if (!cancellationToken.IsCancellationRequested)
            {
                Console.Error.WriteLine($"Error al buscar direcciones: {ex.Message}");
                direcciones.Clear();
            }
        }
        finally
        {
            _loading = false;
            await InvokeAsync(StateHasChanged);
        }
    }


    private DateTime[] FechaRange
    {
        get => new DateTime[] { Model.FechaSalida, Model.FechaLlegada };
        set
        {
            if (value.Length == 1)
            {
                Model.FechaSalida = value[0];
            }
        }
    }

    public async Task<List<SimpleFuerzaViewModel>> MapearFuerzasAsync(List<FuerzaInterviniente> fuerzas)
    {
        return await Task.Run(() => fuerzas.Select(f => new SimpleFuerzaViewModel
        {
            Id = f.Id,
            Nombre = f.NombreFuerza ?? string.Empty
        }).ToList());
    }

    private string GetGoogleMapsSatelliteUrl(double latitud, double longitud)
    {
        // Redondear coordenadas
        string latString = Math.Round(latitud, 5).ToString(System.Globalization.CultureInfo.InvariantCulture);
        string lonString = Math.Round(longitud, 5).ToString(System.Globalization.CultureInfo.InvariantCulture);

        // URL base de Google Maps sin API Key
        // Parámetros:
        // q = coordenadas
        // t = tipo de mapa (k = satélite)
        // z = zoom (ej. 14)
        string url = $"https://www.google.com/maps?q={latString},{lonString}&t=k&z=14&output=embed";

        return url;
    }

    public void Dispose()
    {
        _searchCancellationTokenSource?.Cancel();
        _searchCancellationTokenSource?.Dispose();
    }
}