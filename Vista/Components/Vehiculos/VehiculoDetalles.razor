@implements IDisposable
@inject IDbContextFactory<BomberosDbContext> DbFactory
@using Vista.Data.Models.Imagenes
@using Vista.Data.Models.Personas.Personal
@using Vista.Data.Models.Personas.Personal.Componentes
@using Vista.Data.Models.Vehiculos.Flota
@using AntDesign;

<link rel="stylesheet" href="/css/DetallesVehiculosEstilos.css" />

@if (vehiculo != null)
{
    <div class="vehiculo-detalles-completo-container">
        <div class="image-and-number-wrapper">
            <div class="image-container-completo">
                <img id="ImagenMovil" class="vehiculo-image-completo" src="@CargarImage()" alt="Imagen de la Unidad" />
            </div>
            <div class="movil-number-container">
                Unidad N° @vehiculoView.NumeroMovil
            </div>
        </div>

        <div class="info-completo-container">
            <h3 class="section-title">Detalles del Vehículo:</h3>
            
            <Row Gutter="@((32, 24))" Class="detail-grid">
                <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                    <div class="detail-item">
                        <span class="detail-label">Marca:</span>
                        <span class="detail-value">@vehiculoView.Marca</span>
                    </div>
                </AntDesign.Col>
                <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                    <div class="detail-item">
                        <span class="detail-label">Modelo:</span>
                        <span class="detail-value">@vehiculoView.Modelo</span>
                    </div>
                </AntDesign.Col>
                <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                    <div class="detail-item">
                        <span class="detail-label">Año:</span>
                        <span class="detail-value">@vehiculoView.Año</span>
                    </div>
                </AntDesign.Col>
                <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                    <div class="detail-item">
                        <span class="detail-label">Patente:</span>
                        <span class="detail-value">@vehiculoView.Patente</span>
                    </div>
                </AntDesign.Col>
                <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                    <div class="detail-item">
                        <span class="detail-label">Tipo:</span>
                        <span class="detail-value">@vehiculoView.Tipo</span>
                    </div>
                </AntDesign.Col>
                <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                    <div class="detail-item">
                        <span class="detail-label">Encargado:</span>
                        <span class="detail-value">@vehiculoView.Encargado</span>
                    </div>
                </AntDesign.Col>
                <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                    <div class="detail-item">
                        <span class="detail-label">Estado:</span>
                        <span class="detail-value">@vehiculoView.Estado</span>
                    </div>
                </AntDesign.Col>
            </Row>

            @if (vehiculo is Movil)
            {
                <div class="technical-details-section">
                    <h4 class="section-title">Datos Técnicos:</h4>
                    <Row Gutter="@((32, 24))" Class="detail-grid">
                        <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">N° Motor:</span>
                                <span class="detail-value">@vehiculoView.NumeroMotor</span>
                            </div>
                        </AntDesign.Col>
                        <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">N° Chasis:</span>
                                <span class="detail-value">@vehiculoView.NumeroChasis</span>
                            </div>
                        </AntDesign.Col>
                        <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">Modelo Bomba:</span>
                                <span class="detail-value">@vehiculoView.ModeloBomba</span>
                            </div>
                        </AntDesign.Col>
                        <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">Cantidad de Litros:</span>
                                <span class="detail-value">@vehiculoView.CantidadLitros</span>
                            </div>
                        </AntDesign.Col>
                         <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">Tipo de Aceite:</span>
                                <span class="detail-value">@vehiculoView.TipoAceite</span>
                            </div>
                        </AntDesign.Col>
                         <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">Marca de Aceite:</span>
                                <span class="detail-value">@vehiculoView.MarcaAceite</span>
                            </div>
                        </AntDesign.Col>
                         <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">Cantidad de Aceite:</span>
                                <span class="detail-value">@vehiculoView.CantidadAceite</span>
                            </div>
                        </AntDesign.Col>
                        <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">Combustible:</span>
                                <span class="detail-value">@vehiculoView.Combustible</span>
                            </div>
                        </AntDesign.Col>
                        <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">Fecha Ultimo Service:</span>
                                <span class="detail-value">@vehiculoView.FechaUltimoService</span>
                            </div>
                        </AntDesign.Col>
                        <AntDesign.Col Xs="24" Sm="12" Md="8" Lg="6">
                            <div class="detail-item">
                                <span class="detail-label">Fecha Proximo Service:</span>
                                <span class="detail-value">@vehiculoView.FechaProximoService</span>
                            </div>
                        </AntDesign.Col>
                    </Row>
                </div>
            }
        </div>
    </div>
}
else
{
    <div style="display: flex; justify-content: center; width: 100%; margin: 1em 1em;">
        <Spin Delay="500" Indicator=antIcon />
    </div>
}

@code {
    RenderFragment antIcon = @<Icon Type="loading" Theme="IconThemeType.Outline" Style="font-size: 24px; text-align: center; color: rgb(62, 24, 24);" Spin />;

    [Parameter] public int vehiculoId { get; set; }
    BomberosDbContext Context;
    public VehiculoSalida vehiculo { get; set; }
    public VehiculoView vehiculoView { get; set; } = new();
    public ImagenViewModel imagenView { get; set; } = new();

    // View models
    public class VehiculoView
    {
        public string? Tipo { get; set; }
        public string? Encargado { get; set; }
        public string? Marca { get; set; }
        public string? Modelo { get; set; }
        public string? Patente { get; set; }
        public string? Año { get; set; }
        public string? NumeroMovil { get; set; }
        public string? Estado { get; set; }
        public string? NumeroMotor { get; set; }
        public string? NumeroChasis { get; set; }
        public string? ModeloBomba { get; set; }
        public string? CantidadLitros { get; set; }
        public string? Combustible { get; set; }
        public string? FechaUltimoService { get; set; }
        public string? FechaProximoService { get; set; }
        public string? TipoAceite { get; set; }
        public string? MarcaAceite { get; set; }
        public string? CantidadAceite { get; set; }
        public string? Observaciones { get; set; }
        public string? ModeloFiltroAire { get; set; }
        public string? MedidasCubiertas { get; set; }
        public string? LibrasCubiertas { get; set; }
        public string? CajasVelocidades { get; set; }
        public string? TensionCElectrico { get; set; }
        public string? TipoDireccion { get; set; }
        public string? MarcaBateria { get; set; }
        public string? FechaUltimoCambioBateria { get; set; }
    }

    public class ImagenViewModel
    {
        public string? Base64 { get; set; }
        public string? TipoImagen { get; set; }
        public string? Nombre { get; set; }
    }

    // Funciones - Carga de datos
    public async Task CargarDatos()
    {
        vehiculo = await Context.Set<VehiculoSalida>().SingleOrDefaultAsync(v => v.VehiculoId == vehiculoId);
        if (vehiculo != null)
        {
            vehiculoView = new VehiculoView
                {
                    Tipo = vehiculo.Tipo,
                    Marca = vehiculo.Marca,
                    Modelo = vehiculo.Modelo,
                    Patente = vehiculo.Patente,
                    Año = vehiculo.Año?.ToString(),
                    NumeroMovil = vehiculo.NumeroMovil?.ToString(),
                    Estado = vehiculo.Estado.ToString(),
                    Combustible = vehiculo.Combustible,
                    FechaUltimoService = vehiculo.FechaUltimoService.ToString(),
                    FechaProximoService = vehiculo.FechaProximoService.ToString(),
                    Observaciones = vehiculo.Observaciones
                };

            if (vehiculo.EncargadoId != null)
            {
                Bombero? Encargado = await Context.Bomberos.SingleOrDefaultAsync(b => b.PersonaId == vehiculo.EncargadoId);
                vehiculoView.Encargado = Encargado?.Nombre + " " + Encargado?.Apellido;
            }

            if (vehiculo is Movil movil)
            {
                vehiculoView.NumeroMotor = movil.NumeroMotor;
                vehiculoView.NumeroChasis = movil.NumeroChasis;
                vehiculoView.ModeloBomba = movil.ModeloBomba;
                vehiculoView.CantidadLitros = movil.CantidadLitros?.ToString();
                vehiculoView.TipoAceite = movil.TipoAceite;
                vehiculoView.MarcaAceite = movil.MarcaAceite;
                vehiculoView.CantidadAceite = movil.CantidadAceite.ToString();
                vehiculoView.ModeloFiltroAire = movil.ModeloFiltroAire;
                vehiculoView.MedidasCubiertas = movil.MedidasCubiertas;
                vehiculoView.LibrasCubiertas = movil.LibrasCubiertas;
                vehiculoView.CajasVelocidades = movil.CajaVelocidades.ToString();
                vehiculoView.TensionCElectrico = movil.TensionCElectrico.ToString();
                vehiculoView.TipoDireccion = movil.TipoDireccion.ToString();
                vehiculoView.MarcaBateria = movil.MarcaBateria;
                vehiculoView.FechaUltimoCambioBateria = movil.FechaUltCambioBateria.ToString();
            }
        }
    }

    public string CargarImage()
    {
        string src = "/";
        Imagen? imagen = Context.ImagenesVehiculo.Where(i => i.ImagenId == vehiculo.ImagenId).SingleOrDefault();
        if (imagen is not null)
        {
            src = $"data:{imagen.TipoImagen};base64,{imagen.Base64Imagen}";
        }
        return src;
    }

    protected override async Task OnInitializedAsync()
    {
        await Init();
    }

    private async Task Init()
    {
        Context = DbFactory.CreateDbContext();
        await CargarDatos();
    }

    public void Dispose()
    {
        Context?.Dispose();
    }
}