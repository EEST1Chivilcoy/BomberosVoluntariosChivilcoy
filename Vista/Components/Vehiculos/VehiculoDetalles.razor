@implements IDisposable
@inject IDbContextFactory<BomberosDbContext> DbFactory
@using Vista.Data.Models.Imagenes
@using Vista.Data.Models.Personas.Personal
@using Vista.Data.Models.Personas.Personal.Componentes
@using Vista.Data.Models.Vehiculos.Flota
@using AntDesign;

@if (vehiculo != null)
{
    <div style="padding: 16px;">
        <!-- Header con imagen y número de móvil -->
        <Card Style="margin-bottom: 24px; text-align: center;" Bordered="false">
            <Body>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                    <div style="display: flex; justify-content: center;">
                        <Avatar Shape="AvatarShape.Square" 
                                Size="@GetAvatarSize()" 
                                Src="@CargarImage()" 
                                Alt="Imagen de la Unidad"
                                Style="border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" />
                    </div>
                    <Title Level="2" Style="margin: 0; color: #1890ff; text-align: center;">
                        Unidad N° @vehiculoView.NumeroMovil
                    </Title>
                </div>
            </Body>
        </Card>

        <!-- Detalles básicos del vehículo -->
        <Card Title="Detalles del Vehículo" Style="margin-bottom: 24px;" Bordered="true">
            <Body>
                <Descriptions Bordered Size="DescriptionsSize.Small" Column="@GetResponsiveColumns()">
                    <DescriptionsItem Title="Marca">
                        @(string.IsNullOrEmpty(vehiculoView.Marca) ? "No especificado" : vehiculoView.Marca)
                    </DescriptionsItem>
                    <DescriptionsItem Title="Modelo">
                        @(string.IsNullOrEmpty(vehiculoView.Modelo) ? "No especificado" : vehiculoView.Modelo)
                    </DescriptionsItem>
                    <DescriptionsItem Title="Año">
                        @(string.IsNullOrEmpty(vehiculoView.Año) ? "No especificado" : vehiculoView.Año)
                    </DescriptionsItem>
                    <DescriptionsItem Title="Patente">
                        @(string.IsNullOrEmpty(vehiculoView.Patente) ? "No especificado" : vehiculoView.Patente)
                    </DescriptionsItem>
                    <DescriptionsItem Title="Tipo">
                        @(string.IsNullOrEmpty(vehiculoView.Tipo) ? "No especificado" : vehiculoView.Tipo)
                    </DescriptionsItem>
                    <DescriptionsItem Title="Combustible">
                        @(string.IsNullOrEmpty(vehiculoView.Combustible) ? "No especificado" : vehiculoView.Combustible)
                    </DescriptionsItem>
                    <DescriptionsItem Title="Encargado">
                        @(string.IsNullOrEmpty(vehiculoView.Encargado) ? "Sin asignar" : vehiculoView.Encargado)
                    </DescriptionsItem>
                    <DescriptionsItem Title="Estado">
                        <Tag Color="@GetEstadoColor()">@vehiculoView.Estado</Tag>
                    </DescriptionsItem>
                    <DescriptionsItem Title="Fecha Último Service">@vehiculoView.FechaUltimoService</DescriptionsItem>
                    <DescriptionsItem Title="Fecha Próximo Service">@vehiculoView.FechaProximoService</DescriptionsItem>
                    <DescriptionsItem Title="Observaciones" Span="@GetObservacionesSpan()">
                        @if (!string.IsNullOrEmpty(vehiculoView.Observaciones))
                        {
                            <Paragraph Style="margin: 0; word-break: break-word;">@vehiculoView.Observaciones</Paragraph>
                        }
                        else
                        {
                            <span style="color: #8c8c8c; font-style: italic;">Sin observaciones</span>
                        }
                    </DescriptionsItem>
                </Descriptions>
            </Body>
        </Card>

        <!-- Datos técnicos (solo para móviles) -->
        @if (vehiculo is Movil)
        {
            <Card Title="Datos Técnicos" Bordered="true">
                <Body>
                    <Descriptions Bordered Size="DescriptionsSize.Small" Column="@GetResponsiveColumns()">
                        <DescriptionsItem Title="N° Motor">
                            @(string.IsNullOrEmpty(vehiculoView.NumeroMotor) ? "No especificado" : vehiculoView.NumeroMotor)
                        </DescriptionsItem>
                        <DescriptionsItem Title="N° Chasis">
                            @(string.IsNullOrEmpty(vehiculoView.NumeroChasis) ? "No especificado" : vehiculoView.NumeroChasis)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Modelo Bomba">
                            @(string.IsNullOrEmpty(vehiculoView.ModeloBomba) ? "No especificado" : vehiculoView.ModeloBomba)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Cantidad de Litros">
                            @(string.IsNullOrEmpty(vehiculoView.CantidadLitros) ? "No especificado" : vehiculoView.CantidadLitros + " L")
                        </DescriptionsItem>
                        <DescriptionsItem Title="Tipo de Aceite">
                            @(string.IsNullOrEmpty(vehiculoView.TipoAceite) ? "No especificado" : vehiculoView.TipoAceite)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Marca de Aceite">
                            @(string.IsNullOrEmpty(vehiculoView.MarcaAceite) ? "No especificado" : vehiculoView.MarcaAceite)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Cantidad de Aceite">
                            @(string.IsNullOrEmpty(vehiculoView.CantidadAceite) ? "No especificado" : vehiculoView.CantidadAceite + " L")
                        </DescriptionsItem>
                        <DescriptionsItem Title="Modelo Filtro Aire">
                            @(string.IsNullOrEmpty(vehiculoView.ModeloFiltroAire) ? "No especificado" : vehiculoView.ModeloFiltroAire)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Medidas Cubiertas">
                            @(string.IsNullOrEmpty(vehiculoView.MedidasCubiertas) ? "No especificado" : vehiculoView.MedidasCubiertas)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Libras Cubiertas">
                            @(string.IsNullOrEmpty(vehiculoView.LibrasCubiertas) ? "No especificado" : vehiculoView.LibrasCubiertas)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Cajas de Velocidades">
                            @(string.IsNullOrEmpty(vehiculoView.CajasVelocidades) ? "No especificado" : vehiculoView.CajasVelocidades)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Tensión C. Eléctrico">
                            @(string.IsNullOrEmpty(vehiculoView.TensionCElectrico) ? "No especificado" : vehiculoView.TensionCElectrico + " V")
                        </DescriptionsItem>
                        <DescriptionsItem Title="Tipo Dirección">
                            @(string.IsNullOrEmpty(vehiculoView.TipoDireccion) ? "No especificado" : vehiculoView.TipoDireccion)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Marca Batería">
                            @(string.IsNullOrEmpty(vehiculoView.MarcaBateria) ? "No especificado" : vehiculoView.MarcaBateria)
                        </DescriptionsItem>
                        <DescriptionsItem Title="Fecha Último Cambio Batería">@vehiculoView.FechaUltimoCambioBateria</DescriptionsItem>
                    </Descriptions>
                </Body>
            </Card>
        }
    </div>
}
else
{
    <div style="display: flex; justify-content: center; align-items: center; padding: 60px;">
        <div style="text-align: center;">
            <Spin Size="SpinSize.Large" />
            <div style="margin-top: 16px; color: #8c8c8c;">Cargando datos del vehículo...</div>
        </div>
    </div>
}

@code {
    [Parameter] public int vehiculoId { get; set; }
    BomberosDbContext Context;
    public VehiculoSalida vehiculo { get; set; }
    public VehiculoView vehiculoView { get; set; } = new();
    public ImagenViewModel imagenView { get; set; } = new();

    // View models
    public class VehiculoView
    {
        public string? Tipo { get; set; }
        public string? Encargado { get; set; }
        public string? Marca { get; set; }
        public string? Modelo { get; set; }
        public string? Patente { get; set; }
        public string? Año { get; set; }
        public string? NumeroMovil { get; set; }
        public string? Estado { get; set; }
        public string? NumeroMotor { get; set; }
        public string? NumeroChasis { get; set; }
        public string? ModeloBomba { get; set; }
        public string? CantidadLitros { get; set; }
        public string? Combustible { get; set; }
        public string? FechaUltimoService { get; set; }
        public string? FechaProximoService { get; set; }
        public string? TipoAceite { get; set; }
        public string? MarcaAceite { get; set; }
        public string? CantidadAceite { get; set; }
        public string? Observaciones { get; set; }
        public string? ModeloFiltroAire { get; set; }
        public string? MedidasCubiertas { get; set; }
        public string? LibrasCubiertas { get; set; }
        public string? CajasVelocidades { get; set; }
        public string? TensionCElectrico { get; set; }
        public string? TipoDireccion { get; set; }
        public string? MarcaBateria { get; set; }
        public string? FechaUltimoCambioBateria { get; set; }
    }

    public class ImagenViewModel
    {
        public string? Base64 { get; set; }
        public string? TipoImagen { get; set; }
        public string? Nombre { get; set; }
    }

    // Funciones - Carga de datos
    public async Task CargarDatos()
    {
        vehiculo = await Context.Set<VehiculoSalida>().SingleOrDefaultAsync(v => v.VehiculoId == vehiculoId);
        if (vehiculo != null)
        {
            vehiculoView = new VehiculoView
                {
                    Tipo = vehiculo.Tipo,
                    Marca = vehiculo.Marca,
                    Modelo = vehiculo.Modelo,
                    Patente = vehiculo.Patente,
                    Año = vehiculo.Año?.ToString(),
                    NumeroMovil = vehiculo.NumeroMovil?.ToString(),
                    Estado = vehiculo.Estado.ToString(),
                    Combustible = vehiculo.Combustible,
                    FechaUltimoService = vehiculo.FechaUltimoService?.ToString("dd/MM/yyyy") ?? "No registrado",
                    FechaProximoService = vehiculo.FechaProximoService?.ToString("dd/MM/yyyy") ?? "No programado",
                    Observaciones = vehiculo.Observaciones
                };

            if (vehiculo.EncargadoId != null)
            {
                Bombero? Encargado = await Context.Bomberos.SingleOrDefaultAsync(b => b.PersonaId == vehiculo.EncargadoId);
                vehiculoView.Encargado = $"{Encargado?.Nombre} {Encargado?.Apellido}".Trim();
            }

            if (vehiculo is Movil movil)
            {
                vehiculoView.NumeroMotor = movil.NumeroMotor;
                vehiculoView.NumeroChasis = movil.NumeroChasis;
                vehiculoView.ModeloBomba = movil.ModeloBomba;
                vehiculoView.CantidadLitros = movil.CantidadLitros?.ToString();
                vehiculoView.TipoAceite = movil.TipoAceite;
                vehiculoView.MarcaAceite = movil.MarcaAceite;
                vehiculoView.CantidadAceite = movil.CantidadAceite?.ToString();
                vehiculoView.ModeloFiltroAire = movil.ModeloFiltroAire;
                vehiculoView.MedidasCubiertas = movil.MedidasCubiertas;
                vehiculoView.LibrasCubiertas = movil.LibrasCubiertas;
                vehiculoView.CajasVelocidades = movil.CajaVelocidades?.ToString();
                vehiculoView.TensionCElectrico = movil.TensionCElectrico?.ToString();
                vehiculoView.TipoDireccion = movil.TipoDireccion?.ToString();
                vehiculoView.MarcaBateria = movil.MarcaBateria;
                vehiculoView.FechaUltimoCambioBateria = movil.FechaUltCambioBateria?.ToString("dd/MM/yyyy") ?? "No registrado";
            }
        }
    }

    public string CargarImage()
    {
        string src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjZjBmMGYwIi8+CjxwYXRoIGQ9Ik02NCA0NEM2NC4yMzA3IDQ0IDY0LjQ2MTQgNDMuOTM4NSA2NC42ODQxIDQzLjgxMzVDNjQuOTA2NyA0My42ODg1IDY1LjEyMTMgNDMuNTAwCA2NS4zMzc3IDQzLjI4NEM2NS41NTQxIDQzLjA2NzYgNjUuNzQyMiA0Mi44NTMgNjUuODY3MiA0Mi42MzA0QzY1Ljk5MjIgNDIuNDA3OCA2Ni4wNTM3IDQyLjE3NzEgNjYuMDUzNyA0MS45NDY0VjMyLjA1MzZDNjYuMDUzNyAzMS4zNzM2IDY1LjQ5NDEgMzAuODE0IDY0LjgxNDEgMzAuODE0SDYzLjE4NTlDNjIuNTA1OSAzMC44MTQgNjEuOTQ2MyAzMS4zNzM2IDYxLjk0NjMgMzIuMDUzNlY0MS45NDY0QzYxLjk0NjMgNDIuMTc3MSA2Mi4wMDc4IDQyLjQwNzggNjIuMTMyOCA0Mi42MzA0QzYyLjI1NzggNDIuODUzIDYyLjQ0NTkgNDMuMDY3NiA2Mi42NjIzIDQzLjI4NEM2Mi44Nzg3IDQzLjUwMDQgNjMuMDkzMyA0My42ODg1IDYzLjMxNTkgNDMuODEzNUM2My41Mzg2IDQzLjkzODUgNjMsNzY5MyA0NFoiIGZpbGw9IiM4QzhjOGMiLz4KPHRleHQgeD0iNjQiIHk9Ijk4IiBmb250LWZhbWlseT0iQXJpaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOEM4QzhDIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5WZWjDrWN1bG88L3RleHQ+Cjwvc3ZnPGo="; // SVG base64 por defecto
        
        try
        {
            Imagen? imagen = Context.ImagenesVehiculo.Where(i => i.ImagenId == vehiculo.ImagenId).SingleOrDefault();
            if (imagen is not null && !string.IsNullOrEmpty(imagen.Base64Imagen))
            {
                src = $"data:{imagen.TipoImagen};base64,{imagen.Base64Imagen}";
            }
        }
        catch
        {
            // En caso de error, usar imagen por defecto
        }
        
        return src;
    }

    // Función para obtener el color del tag del estado
    private string GetEstadoColor()
    {
        return vehiculoView.Estado?.ToLower() switch
        {
            "activo" => "green",
            "inactivo" => "red",
            "mantenimiento" => "orange",
            "enreparacion" => "orange",
            "disponible" => "blue",
            _ => "default"
        };
    }

    // Función responsive para las columnas de Descriptions
    private int GetResponsiveColumns()
    {
        return 2; // 2 columnas para mantener legibilidad en el modal
    }

    // Función para determinar el span de observaciones
    private int GetObservacionesSpan()
    {
        return 2; // Span completo en una fila de 2 columnas
    }

    // Función para obtener el tamaño del avatar responsivo
    private string GetAvatarSize()
    {
        return "120px"; // Tamaño fijo óptimo para modales
    }

    protected override async Task OnInitializedAsync()
    {
        await Init();
    }

    private async Task Init()
    {
        Context = DbFactory.CreateDbContext();
        await CargarDatos();
    }

    public void Dispose()
    {
        Context?.Dispose();
    }
}