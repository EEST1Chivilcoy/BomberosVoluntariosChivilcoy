@using Vista.Data.Enums.Socios
@using Vista.Data.Enums.Discriminadores
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel
@using AntDesign.TableModels
@using System.Text.Json
@using Vista.Data.Models.Imagenes
@using Vista.Pages.Socios.ABM.Componentes
@using Vista.Data.Enums.Personal.Cobrador
@using Vista.Data.Mappers

@page "/fire-force/socios"

@*Servicios utilizados*@
@using Vista.Services
@inject IMessageService message
@inject ISocioService SocioService
@inject NavigationManager navigationManager

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "administrador,secretaria")]

<style>
    /* Variables CSS para colores principales - Prefijo para evitar conflictos */
    .personal-abm {
        --abm-primary-color: #A63333;
        --abm-primary-dark: #732D2D;
        --abm-success-color: #4CAF50;
        --abm-success-dark: #438E46;
        --abm-warning-color: #F57F17;
        --abm-warning-light: #FFF8E1;
        --abm-error-color: #C62828;
        --abm-error-light: #FFEBEE;
        --abm-approved-color: #2E7D32;
        --abm-approved-light: #E6F7E9;
        --abm-gold-color: #FFD700;
    }

        .personal-abm .abm-container {
            padding: 12px !important;
            min-height: 100vh !important;
        }

        .personal-abm .abm-main-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 16px !important;
            box-shadow: 0 8px 32px rgba(166, 51, 51, 0.1), 0 4px 16px rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            overflow: hidden !important;
        }

        .personal-abm .abm-header-section {
            background: linear-gradient(135deg, #A63333 0%, #732D2D 100%) !important;
            color: white !important;
            padding: 28px !important;
            position: relative !important;
            overflow: hidden !important;
            margin-bottom: 0 !important;
        }

            .personal-abm .abm-header-section::before {
                content: '';
                display: none;
            }

            .personal-abm .abm-header-section .lava-bubbles {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
                overflow: hidden;
            }

            .personal-abm .abm-header-section .lava-bubble {
                position: absolute;
                border-radius: 50%;
                opacity: 0.45;
                background: radial-gradient(circle at 60% 40%, #FFD54F 0%, #F9A825 80%, transparent 100%);
                animation: lava-bubble-move 8s linear infinite;
                filter: blur(1.5px);
                mix-blend-mode: lighten;
            }

                .personal-abm .abm-header-section .lava-bubble.b1 {
                    left: 10%;
                    width: 60px;
                    height: 60px;
                    bottom: -70px;
                    animation-delay: 0s;
                    animation-duration: 7.5s;
                }

                .personal-abm .abm-header-section .lava-bubble.b2 {
                    left: 35%;
                    width: 90px;
                    height: 90px;
                    bottom: -100px;
                    animation-delay: 2s;
                    animation-duration: 9s;
                    background: radial-gradient(circle at 60% 40%, #FFEB3B 0%, #FFD54F 80%, transparent 100%);
                }

                .personal-abm .abm-header-section .lava-bubble.b3 {
                    left: 65%;
                    width: 50px;
                    height: 50px;
                    bottom: -60px;
                    animation-delay: 1.5s;
                    animation-duration: 6.5s;
                    background: radial-gradient(circle at 60% 40%, #FFFDE7 0%, #FFD54F 80%, transparent 100%);
                }

                .personal-abm .abm-header-section .lava-bubble.b4 {
                    left: 80%;
                    width: 70px;
                    height: 70px;
                    bottom: -80px;
                    animation-delay: 3.2s;
                    animation-duration: 8.5s;
                    background: radial-gradient(circle at 60% 40%, #F9A825 0%, #FFD54F 80%, transparent 100%);
                }

                .personal-abm .abm-header-section .lava-bubble.b5 {
                    left: 55%;
                    width: 40px;
                    height: 40px;
                    bottom: -50px;
                    animation-delay: 5s;
                    animation-duration: 7.2s;
                    background: radial-gradient(circle at 60% 40%, #FFFDE7 0%, #F9A825 80%, transparent 100%);
                }

    @@keyframes lava-bubble-move {
        0% {
            transform: translateY(0) scale(1) rotate(0deg);
            opacity: 0.45;
        }

        60% {
            opacity: 0.7;
            filter: blur(2.5px);
        }

        80% {
            transform: translateY(-220px) scale(1.15) rotate(10deg);
            opacity: 0.6;
        }

        100% {
            transform: translateY(-320px) scale(0.95) rotate(-8deg);
            opacity: 0;
        }
    }

    .personal-abm .abm-header-section .main-title {
        font-family: 'Poppins', 'Fjalla One', sans-serif !important;
        font-size: 2.2rem !important;
        font-weight: 700 !important;
        letter-spacing: 1px !important;
        margin: 0 !important;
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        animation: text-glow 2.5s ease-in-out infinite alternate !important;
        position: relative !important;
        z-index: 2 !important;
    }

    .personal-abm .abm-header-section .title-icon {
        color: #FFD54F !important;
        font-size: 2rem !important;
        filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.25)) !important;
    }

    @@keyframes text-glow {
        0%, 100% {
            text-shadow: 0 0 5px #F9A825, 0 0 10px #FFD54F;
        }

        50% {
            text-shadow: 0 0 12px #F9A825, 0 0 22px #FFD54F;
        }
    }

    .personal-abm .abm-header-section .title-container {
        position: relative !important;
        z-index: 2 !important;
        margin-bottom: 20px !important;
    }

    /* Filtros responsivos - Matching licenses layout */
    .personal-abm .filters-section {
        position: relative !important;
        z-index: 2 !important;
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }

    .personal-abm .actions-row {
        display: grid !important;
        grid-template-columns: 1fr 1fr auto !important;
        gap: 16px !important;
        align-items: center !important;
    }

    .personal-abm .search-container {
        min-width: 0 !important;
    }

    .personal-abm .abm-filters {
        display: grid !important;
        grid-template-columns: 2fr 2fr auto !important;
        align-items: center !important;
        gap: 16px !important;
        margin-bottom: 16px !important;
    }

        .personal-abm .abm-filters .ant-select,
        .personal-abm .abm-filters .ant-input {
            font-size: 16px !important;
            width: 100% !important;
            height: 40px !important;
        }

    .personal-abm .abm-select-estado .ant-select-selector {
        width: 100% !important;
        height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .personal-abm .abm-filters .ant-input-search {
        display: flex !important;
    }

    .personal-abm .abm-filters button {
        height: 40px !important;
        font-size: 16px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 6px !important;
    }

    .personal-abm .ant-table {
        overflow: hidden !important;
        font-size: 16px !important;
        background-color: #ffffff !important;
    }

    .personal-abm .ant-table-thead .ant-table-cell {
        background-color: #A63333 !important;
        color: #fff !important;
        font-weight: bold !important;
        padding: 16px !important;
        border: none !important;
    }

    .personal-abm .ant-table-cell {
        padding: 18px !important;
        border-bottom: 1px solid #f0f0f0 !important;
    }

    .personal-abm .abm-action-buttons {
        display: flex !important;
        justify-content: center !important;
        flex-wrap: wrap !important;
        gap: 8px !important;
    }

        .personal-abm .abm-action-buttons .ant-btn {
            min-width: 110px !important;
            height: 38px !important;
            font-size: 15px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 6px !important;
            line-height: 1.2 !important;
            padding: 0 12px !important;
        }

    .personal-abm .ant-btn-dangerous {
        color: #a63333 !important;
        border-color: #a63333 !important;
    }

        .personal-abm .ant-btn-dangerous:hover {
            background-color: #a63333 !important;
            color: white !important;
        }

    .personal-abm .ant-pagination {
        justify-content: center !important;
        margin-top: 24px !important;
    }

    .personal-abm .ant-pagination-item {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .personal-abm .ant-pagination-prev,
    .personal-abm .ant-pagination-next {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .personal-abm .add-button {
        background: linear-gradient(135deg, #4CAF50 0%, #438E46 100%) !important;
        border: none !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3) !important;
        padding: 0 20px !important;
        font-weight: 600 !important;
        border-radius: 8px !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

        .personal-abm .add-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4) !important;
        }

    .personal-abm .print-button {
        background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%) !important;
        border: none !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3) !important;
        padding: 0 20px !important;
        font-weight: 600 !important;
        border-radius: 8px !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

        .personal-abm .print-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(24, 144, 255, 0.4) !important;
        }

    .print-modal-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border: 2px solid #e8e8e8;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 12px;
    }

        .print-modal-option:hover {
            border-color: #A63333;
            background-color: #fff5f5;
        }

        .print-modal-option.selected {
            border-color: #A63333;
            background-color: #fff5f5;
        }

        .print-modal-option .option-icon {
            font-size: 28px;
            color: #A63333;
        }

        .print-modal-option .option-text h4 {
            margin: 0 0 4px 0;
            color: #333;
            font-weight: 600;
        }

        .print-modal-option .option-text p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }

    .print-modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #f0f0f0;
    }

    .print-confirm-button {
        background: linear-gradient(135deg, #A63333 0%, #732D2D 100%) !important;
        border: none !important;
        color: white !important;
    }

        .print-confirm-button:hover {
            background: linear-gradient(135deg, #732D2D 0%, #5a2323 100%) !important;
        }
</style>



<div class="personal-abm">
    <div class="abm-container">
        <Card Class="abm-main-card fade-in">
            <div class="abm-header-section">
                <div class="lava-bubbles">
                    <div class="lava-bubble b1"></div>
                    <div class="lava-bubble b2"></div>
                    <div class="lava-bubble b3"></div>
                    <div class="lava-bubble b4"></div>
                    <div class="lava-bubble b5"></div>
                </div>
                <div class="title-container">
                    <h1 class="main-title">
                        <Icon Type="user" Class="title-icon" />
                        <span>SOCIOS</span>
                    </h1>
                </div>
                <div class="filters-section">
                    <div class="actions-row abm-filters">

                        <EnumSelect DefaultValue="TipoEstadoSocio.Activo"
                                    ValueChanged="(TipoEstadoSocio estado) => OnEstadoChanged(estado)"
                                    TEnum="TipoEstadoSocio"
                                    Class="abm-select-estado" />

                        <div class="search-container">
                            <Search Placeholder="Buscar por nombre, documento, cuit o N° socio"
                                    @bind-Value="@searchString"
                                    OnSearch="OnSearch"
                                    BindOnInput />
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <Button Type="ButtonType.Primary"
                                    Class="print-button"
                                    OnClick="@OpenPrintModal">
                                <Icon Type="printer" /> Imprimir Lista
                            </Button>

                            <Button Type="ButtonType.Primary"
                                    Class="add-button"
                                    OnClick="@OpenCrearModal">
                                <Icon Type="user-add" /> Agregar Socio
                            </Button>
                        </div>

                    </div>
                </div>
            </div>
            <Table @ref="table"
                   TItem="SocioTableViewModel"
                   DataSource="@sociosFiltrados"
                   OnRow="@OnRowClick"
                   @bind-PageIndex="_pageIndex"
                   @bind-PageSize="_pageSize"
                   Loading="isLoading"
                   Responsive>
                <ColumnDefinitions>
                    <PropertyColumn Title="🆔 N° Socio" Property="s => s.NroSocio" Sortable />
                    <PropertyColumn Title="🏷️ Nombre / Razón Social" Property="s => s.NombreYApellidoSiVa" Sortable />
                    <PropertyColumn Title="📇 Documento / CUIT" Property="s => s.DocumentoOCUIT" Sortable />
                    <PropertyColumn Title="🏘️ Zona" Property="@(c => c.Zona.GetDisplayName())" Sortable />
                    <PropertyColumn Title="🗂️ Tipo" Property="@(c => c.Tipo.GetDisplayName())" Sortable />
                    <PropertyColumn Title="📊 Estado" Property="@(c => c.Estado.GetDisplayName())" Sortable />

                    <ActionColumn Title="⚙️ Acciones" Align=ColumnAlign.Center>
                        <div class="abm-action-buttons" @onclick:stopPropagation>
                            <Button Type="default" OnClick="() => OpenEditarModal(context.Id)">
                                <Icon Type="edit" /> Editar
                            </Button>
                            @if (context.Estado == TipoEstadoSocio.Activo)
                            {
                                <Popconfirm Title="¿Está seguro de dar de baja?"
                                            OkText="Sí" CancelText="No">
                                    <Button Danger>
                                        <Icon Type="down" /> Baja
                                    </Button>
                                </Popconfirm>
                            }
                            else if (context.Estado == TipoEstadoSocio.Inactivo)
                            {
                                <Popconfirm Title="¿Está seguro de dar de alta?"
                                            OkText="Sí" CancelText="No">
                                    <Button Color="Color.Green2">
                                        <Icon Type="up" /> Alta
                                    </Button>
                                </Popconfirm>
                            }
                        </div>
                    </ActionColumn>
                </ColumnDefinitions>
            </Table>
        </Card>
    </div>
</div>

@{
    RenderFragment footer = @<Template>
        <Button OnClick="@CloseModals" @key="@("back")">Cerrar</Button>
    </Template>;
}

@*Modal Detalle Socio*@
<Modal Footer="footer"
       Centered="@true"
       OnCancel="CloseModals"
       Visible="@isModalDetalleVisible"
       DestroyOnClose
       Title=@($"Detalle del Socio")
       DefaultMaximized="@true">
    <DetalleSocio SocioId="selectedSocioId" OnFinishCallback="CloseModals" />
</Modal>


@*Modal Editar Socio*@
<Modal Footer="null"
       Centered="@true"
       OnCancel="CloseModals"
       Visible="@isModalEditarVisible"
       DestroyOnClose
       Title=@($"Editar Socio")
       DefaultMaximized="@true">
    <EditarSocio SocioId="selectedSocioId" OnFinishCallback="CloseEditarModal" />
</Modal>


@*Modal Crear Socio*@

<Modal Title="Crear Socio"
       Footer="footer"
       Centered="@true"
       OnCancel="CloseModals"
       Visible="@isModalCrearVisible"
       Width="600">
    <div style="padding: 24px;">
        <h3 style="text-align: center; margin-bottom: 32px; color: #A63333; font-weight: 600;">
            Seleccione el tipo de socio a crear
        </h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- Card Persona -->
            <NavLink href="/fire-force/socios/crear/persona" style="text-decoration: none;">
                <Card Hoverable="true" Style="cursor: pointer; border: 2px solid #e8e8e8; border-radius: 12px; transition: all 0.3s ease;">
                    <div style="text-align: center; padding: 24px;">
                        <Icon Type="user" Style="font-size: 64px; color: #4CAF50; margin-bottom: 16px;" />
                        <h4 style="margin: 0 0 8px 0; color: #333; font-weight: 600; font-size: 20px;">Persona</h4>
                        <p style="margin: 0; color: #666; font-size: 14px;">Socio individual</p>
                    </div>
                </Card>
            </NavLink>

            <!-- Card Empresa -->
            <NavLink href="/fire-force/socios/crear/empresa" style="text-decoration: none;">
                <Card Hoverable="true" Style="cursor: pointer; border: 2px solid #e8e8e8; border-radius: 12px; transition: all 0.3s ease;">
                    <div style="text-align: center; padding: 24px;">
                        <Icon Type="bank" Style="font-size: 64px; color: #1890ff; margin-bottom: 16px;" />
                        <h4 style="margin: 0 0 8px 0; color: #333; font-weight: 600; font-size: 20px;">Empresa</h4>
                        <p style="margin: 0; color: #666; font-size: 14px;">Socio corporativo</p>
                    </div>
                </Card>
            </NavLink>
        </div>
    </div>
</Modal>

@*Modal Imprimir Lista de Socios*@
<Modal Title="Imprimir Lista de Socios"
       Footer="null"
       Centered="@true"
       OnCancel="ClosePrintModal"
       Visible="@isModalPrintVisible"
       Width="500">
    <div style="padding: 16px;">
        <h4 style="text-align: center; margin-bottom: 24px; color: #A63333; font-weight: 600;">
            <Icon Type="printer" style="margin-right: 8px;" />
            Seleccione qué desea imprimir
        </h4>

        <div class="print-modal-option @(selectedPrintZona == null ? "selected" : "")"
             @onclick="() => SelectPrintZona(null)">
            <Icon Type="global" Class="option-icon" />
            <div class="option-text">
                <h4>Todas las Zonas</h4>
                <p>Imprimir listado completo de todos los socios</p>
            </div>
        </div>

        @foreach (var zona in GetZonasDisponibles())
        {
            <div class="print-modal-option @(selectedPrintZona == zona ? "selected" : "")"
                 @onclick="() => SelectPrintZona(zona)">
                <Icon Type="environment" Class="option-icon" />
                <div class="option-text">
                    <h4>@zona.GetDisplayName()</h4>
                    <p>Imprimir solo socios de esta zona</p>
                </div>
            </div>
        }

        <div class="print-modal-actions">
            <Button OnClick="ClosePrintModal">
                Cancelar
            </Button>
            <Button Type="ButtonType.Primary" Class="print-confirm-button" OnClick="ConfirmPrint">
                <Icon Type="printer" /> Imprimir
            </Button>
        </div>
    </div>
</Modal>

@code {
    // Referencia a la tabla
    ITable table;

    // Tamaño de la tabla
    int _pageIndex = 1;
    int _pageSize = 6;

    // ID del Socio seleccionado
    int selectedSocioId = 0;

    // Estado de carga
    bool isLoading = true;

    // Visibilidad de los modales
    bool isModalEditarVisible = false;
    bool isModalDetalleVisible = false;
    bool isModalCrearVisible = false;
    bool isModalPrintVisible = false;

    // Zona seleccionada para imprimir
    Zona? selectedPrintZona = null;

    // Filtros
    private string searchString = string.Empty;
    private TipoEstadoSocio estadoSeleccionado = TipoEstadoSocio.Activo;

    // Lista de Socios
    private List<SocioTableViewModel> socios = new();
    private List<SocioTableViewModel> sociosFiltrados = new();

    // ViewModel de la Tabla
    public class SocioTableViewModel
    {
        public int Id { get; set; }
        public int NroSocio { get; set; }
        public string? NombreYApellidoSiVa { get; set; }
        public string? DocumentoOCUIT { get; set; }
        public TipoSocio Tipo { get; set; }
        public Zona Zona { get; set; }
        public TipoEstadoSocio Estado { get; set; }
    }

    // Función para manejar el clic en una fila
    private Dictionary<string, object> OnRowClick(RowData<SocioTableViewModel> rowData)
    {
        return new Dictionary<string, object>
        {
            ["onclick"] = Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, () => OpenDetalleModal(rowData.Data.Id))
        };
    }

    private void CloseModals()
    {
        isModalDetalleVisible = false;
        isModalCrearVisible = false;
    }

    private async Task CloseEditarModal()
    {
        isModalEditarVisible = false;
        await OnInitializedAsync();
    }

    private void OpenDetalleModal(int socioId)
    {
        selectedSocioId = socioId;
        isModalDetalleVisible = true;
    }

    private void OpenEditarModal(int socioId)
    {
        selectedSocioId = socioId;
        isModalEditarVisible = true;
    }

    private void OpenCrearModal()
    {
        isModalCrearVisible = true;
    }

    private void OpenPrintModal()
    {
        selectedPrintZona = null;
        isModalPrintVisible = true;
    }

    private void ClosePrintModal()
    {
        isModalPrintVisible = false;
    }

    private void SelectPrintZona(Zona? zona)
    {
        selectedPrintZona = zona;
    }

    private IEnumerable<Zona> GetZonasDisponibles()
    {
        return new[] { Zona.Zona1, Zona.Zona2, Zona.Zona3, Zona.Zona4, Zona.Zona5 };
    }

    private void ConfirmPrint()
    {
        string url;
        if (selectedPrintZona.HasValue)
        {
            url = $"/fire-force/socios/imprimibles/lista-de-socios/{(int)selectedPrintZona.Value}";
        }
        else
        {
            url = "/fire-force/socios/imprimibles/lista-de-socios";
        }

        navigationManager.NavigateTo(url, forceLoad: true);
        isModalPrintVisible = false;
    }

    private void OnEstadoChanged(TipoEstadoSocio estado)
    {
        estadoSeleccionado = estado;
        AplicarFiltros();
    }

    private void OnSearch()
    {
        AplicarFiltros();
    }

    private void AplicarFiltros()
    {
        var query = socios.AsEnumerable();

        // Filtrar por estado
        query = query.Where(s => s.Estado == estadoSeleccionado);

        // Filtrar por búsqueda
        if (!string.IsNullOrWhiteSpace(searchString))
        {
            var searchTerm = searchString.Trim().ToLower();
            query = query.Where(s =>
                (s.NombreYApellidoSiVa != null && s.NombreYApellidoSiVa.ToLower().Contains(searchTerm)) ||
                (s.DocumentoOCUIT != null && s.DocumentoOCUIT.ToLower().Contains(searchTerm)) ||
                s.NroSocio.ToString().Contains(searchTerm)
            );
        }

        sociosFiltrados = query.ToList();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadSocios();
    }

    private async Task LoadSocios()
    {
        isLoading = true;
        try
        {
            var sociosData = await SocioService.ObtenerSociosAsync();

            if (sociosData == null)
            {
                socios = new List<SocioTableViewModel>();
                sociosFiltrados = new List<SocioTableViewModel>();
                return;
            }

            socios = sociosData.Select(s => new SocioTableViewModel
            {
                Id = s.Id,
                NroSocio = s.NroSocio,
                NombreYApellidoSiVa = s.Nombre + " " + s.Apellido,
                DocumentoOCUIT = s.DocumentoOCUIT,
                Tipo = s.Tipo!.Value,
                Zona = s.Zona!.Value,
                Estado = s.EstadoSocio!.Value
            }).ToList();

            // Aplicar filtros iniciales
            AplicarFiltros();
        }
        catch (Exception ex)
        {
            message.Error($"Error al cargar los socios: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}