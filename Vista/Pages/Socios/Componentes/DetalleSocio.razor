@using Vista.Data.Enums.Socios
@using Vista.Data.Enums.Discriminadores
@using Vista.Data.Models.Socios

@*Servicios Utilizados*@
@using Vista.Services
@inject NavigationManager navigationManager
@inject ISocioService SocioService
@inject IMessageService message

<style>
    /* Estilos generales */
    .container {
        padding: 24px !important;
        min-height: 100vh !important;
    }

    .page-title {
        font-size: 24px !important;
        font-weight: 600 !important;
        color: #1f1f1f !important;
        margin-bottom: 24px !important;
        display: flex !important;
        align-items: center !important;
    }

    .page-title-icon {
        margin-right: 12px !important;
        color: #c43a3a !important;
    }

    .card {
        background-color: white !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        padding: 24px !important;
        margin-bottom: 24px !important;
    }

    .card-title {
        font-size: 18px !important;
        font-weight: 500 !important;
        color: #434343 !important;
        margin-bottom: 16px !important;
        padding-bottom: 12px !important;
        border-bottom: 1px solid #f0f0f0 !important;
    }

    /* Estilos de la foto */
    .profile-photo-container {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        padding: 16px !important;
    }

    .photo-preview {
        width: 150px !important;
        height: 150px !important;
        border-radius: 50% !important;
        overflow: hidden !important;
        margin-bottom: 16px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .upload-actions {
        display: flex !important;
        gap: 8px !important;
    }

    /* Estilo para las secciones del formulario */
    .form-section {
        margin-bottom: 24px !important;
    }

    /* Estilo para los botones de acción */
    .action-buttons {
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
        margin-top: 24px !important;
    }

    /* Estilo para los campos */
    .ant-form-item {
        margin-bottom: 16px !important;
    }

    .ant-form-item-label > label {
        color: #595959 !important;
        font-weight: 500 !important;
    }

    .ant-input,
    .ant-select:not(.ant-select-customize-input) .ant-select-selector,
    .ant-picker,
    .ant-input-number {
        border-radius: 4px !important;
        border: 1px solid #d9d9d9 !important;
    }

        .ant-input:hover,
        .ant-select:not(.ant-select-customize-input) .ant-select-selector:hover,
        .ant-picker:hover,
        .ant-input-number:hover {
            border-color: #c43a3a !important;
        }

        .ant-input:focus,
        .ant-select-focused:not(.ant-select-customize-input) .ant-select-selector,
        .ant-picker-focused,
        .ant-input-number-focused {
            border-color: #c43a3a !important;
            box-shadow: 0 0 0 2px rgba(196, 58, 58, 0.2) !important;
        }

    /* Ajuste visual para el switch */
    .ant-switch-checked {
        background-color: #c43a3a !important;
    }

    /* Estilo para campos requeridos */
    .required-field::after {
        content: '*' !important;
        color: #c43a3a !important;
        margin-left: 4px !important;
    }

    /* Estilo para el campo condicional de chofer */
    .conditional-field {
        margin-top: 12px !important;
        padding-top: 12px !important;
        border-top: 1px dashed #f0f0f0 !important;
    }

    .map-container {
        width: 100%;
        aspect-ratio: 1 / 1;
        max-height: 350px;
        border: 1px solid #ccc;
        border-radius: 6px;
        overflow: hidden;
    }

    @@media screen and (max-width: 768px) {
        .map-container {
            max-height: 300px;
            margin-top: 16px;
        }
    }
</style>

<div class="container">
    @if (socioView != null)
    {
        <Form Model="@socioView"
              Layout="FormLayout.Vertical"
              Loading="isLoading">

            @*Información General (Común para todos)*@
            <div class="card">
                <div class="card-title">Información General</div>
                <AntDesign.Row Gutter="24">
                    <AntDesign.Col Span="24">
                        <AntDesign.Row Gutter="16">
                            <AntDesign.Col Span="4">
                                <FormItem Label="Nro Socio">
                                    <Input Value="@socioView.NroSocio" Placeholder="No disponible" ReadOnly />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="10">
                                <FormItem Label="Nombre">
                                    <Input Value="@socioView.Nombre" Placeholder="No disponible" ReadOnly />
                                </FormItem>
                            </AntDesign.Col>
                            @if (socioView is SocioPersonaViewModel sociopersonaView)
                            {
                                <AntDesign.Col Span="10">
                                    <FormItem Label="Apellido">
                                        <Input Value="@sociopersonaView.Apellido" Placeholder="No disponible" ReadOnly />
                                    </FormItem>
                                </AntDesign.Col>
                            }
                        </AntDesign.Row>

                        <AntDesign.Row Gutter="16">
                            <AntDesign.Col Span="8">
                                @if (socioView is SocioPersonaViewModel personalView)
                                {
                                    <FormItem Label="DNI">
                                        <Input Value="@personalView.Documento" Placeholder="No disponible" ReadOnly />
                                    </FormItem>
                                }
                                else if (socioView is SocioEmpresaViewModel empresaView)
                                {
                                    <FormItem Label="CUIT">
                                        <Input Value="@empresaView.CUIT" Placeholder="No disponible" ReadOnly />
                                    </FormItem>
                                }
                            </AntDesign.Col>
                            <AntDesign.Col Span="8">
                                <FormItem Label="Fecha de Ingreso">
                                    <Input Value="@socioView.FechaIngreso" Placeholder="No disponible" ReadOnly />
                                </FormItem>
                            </AntDesign.Col>
                        </AntDesign.Row>

                        <AntDesign.Row Gutter="16">
                            <AntDesign.Col Span="12">
                                <FormItem Label="Dirección">
                                    <Input Value="@socioView.Direccion" Placeholder="No disponible" ReadOnly />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="12">
                                <FormItem Label="Zona">
                                    <Input Value="@socioView.Zona" Placeholder="No disponible" ReadOnly />
                                </FormItem>
                            </AntDesign.Col>
                        </AntDesign.Row>

                        @if (socioView.Latitud.HasValue && socioView.Longitud.HasValue)
                        {
                            <AntDesign.Row Gutter="16">
                                <div class="map-container">
                                    <iframe style="border:0; width: 100%; height: 100%;"
                                            src="@GetGoogleMapsSatelliteUrl(socioView.Latitud.Value, socioView.Longitud.Value)"
                                            frameborder="0"
                                            allowfullscreen>
                                    </iframe>
                                </div>
                            </AntDesign.Row>
                        }

                        <AntDesign.Row Gutter="16">
                            <AntDesign.Col Span="24">
                                <FormItem Label="Ocupación">
                                    <TextArea Value="@socioView.Ocupacion" Placeholder="Ingrese ocupación" Rows="2" MaxLength="255" ReadOnly />
                                </FormItem>
                            </AntDesign.Col>
                        </AntDesign.Row>


                    </AntDesign.Col>
                </AntDesign.Row>
            </div>

            @*Información Profesional*@
            <div class="card">
                <div class="card-title">Información Cuota</div>

                <AntDesign.Row Gutter="16">
                    <AntDesign.Col Span="8">
                        <FormItem Label="Frecuencia de Pago">
                            <Input Value="@socioView.FrecuenciaPago" Placeholder="No disponible" ReadOnly />
                        </FormItem>
                    </AntDesign.Col>
                    <AntDesign.Col Span="8">
                        <FormItem Label="Monto">
                            <Input @bind-Value="@socioView.CuotaValor" Placeholder="No disponible" ReadOnly />
                        </FormItem>
                    </AntDesign.Col>
                    <AntDesign.Col Span="8">
                        <FormItem Label="Forma de Pago">
                            <Input Value="@socioView.FormaPago" Placeholder="No disponible" ReadOnly />
                        </FormItem>
                    </AntDesign.Col>
                </AntDesign.Row>
            </div>

            @*Información de Contacto*@
            <div class="card">
                <div class="card-title">Información de Contacto</div>
                <AntDesign.Row Gutter="16">
                    <AntDesign.Col Span="12">
                        <FormItem Label="Teléfono">
                            <Input Value="@socioView.Telefono" Placeholder="No disponible" ReadOnly />
                        </FormItem>
                    </AntDesign.Col>
                    <AntDesign.Col Span="12">
                        <FormItem Label="Email">
                            <Input Value="@socioView.Email" Placeholder="No disponible" ReadOnly />
                        </FormItem>
                    </AntDesign.Col>
                </AntDesign.Row>
            </div>
        </Form>
    }
    else
    {
        <Result Status="ResultStatus.Error"
                Title="Error"
                SubTitle="No se ha inicializado correctamente el formulario.">
            <Extra>
                <Button Type="@ButtonType.Primary" OnClick="Cancelar">
                    Volver al listado
                </Button>
            </Extra>
        </Result>
    }
</div>

@code {
    [Parameter] public required int SocioId { get; set; }
    [Parameter] public required EventCallback OnFinishCallback { get; set; }

    private SocioViewModel? socioView;

    private bool isLoading = true;

    public abstract class SocioViewModel
    {
        public string? NroSocio { get; set; }

        // -- Datos Generales --

        public string? Nombre { get; set; }

        public string? Direccion { get; set; }

        public double? Latitud { get; set; }

        public double? Longitud { get; set; }

        public string? Zona { get; set; }

        public string? FechaIngreso { get; set; }

        public string? Ocupacion { get; set; }

        // -- Datos de Contacto --

        public string? Telefono { get; set; }

        public string? Email { get; set; }

        // -- Datos de la Cuota --

        public double? CuotaValor { get; set; }

        public string? FrecuenciaPago { get; set; }

        public string? FormaPago { get; set; }
    }

    public class SocioPersonaViewModel : SocioViewModel
    {
        // -- Datos Personales --

        public string? Documento { get; set; }

        public string? Apellido { get; set; }
    }


    public class SocioEmpresaViewModel : SocioViewModel
    {
        // -- Datos de la Empresa --
        public string? CUIT { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            var socio = await SocioService.ObtenerSocioPorIdAsync(SocioId);

            if (socio == null)
            {
                throw new ArgumentNullException("El socio solicitado no existe o ha sido eliminado.");
            }

            MapToViewModel(socio);
        }
        catch (Exception ex)
        {
            await message.ErrorAsync($"Error: {ex.Message}");
            await Cancelar();
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetGoogleMapsSatelliteUrl(double latitud, double longitud)
    {
        // Redondear coordenadas
        string latString = Math.Round(latitud, 5).ToString(System.Globalization.CultureInfo.InvariantCulture);
        string lonString = Math.Round(longitud, 5).ToString(System.Globalization.CultureInfo.InvariantCulture);

        // URL base de Google Maps sin API Key
        // Parámetros:
        // q = coordenadas
        // t = tipo de mapa (k = satélite)
        // z = zoom (18 = máximo zoom cercano para ver detalles de la calle)
        string url = $"https://www.google.com/maps?q={latString},{lonString}&t=k&z=18&output=embed";

        return url;
    }

    private async Task Cancelar()
    {
        await OnFinishCallback.InvokeAsync();
    }

    private void MapToViewModel(Socio socio)
    {
        if (socio.Tipo == TipoSocio.Persona)
        {
            socioView = new SocioPersonaViewModel
            {
                NroSocio = socio.Id.ToString(),
                Nombre = socio.Nombre,
                Apellido = socio.Apellido,
                Documento = socio.DocumentoOCUIT,
                Direccion = socio.Direccion,
                Latitud = socio.Latitud,
                Longitud = socio.Longitud,
                Zona = socio.Zona.GetDisplayName(),
                FechaIngreso = socio.FechaIngreso.ToString("dd/MM/yyyy"),
                Ocupacion = socio.Ocupacion,
                Telefono = socio.Telefono,
                Email = socio.Email,
                CuotaValor = socio.MontoCuota,
                FrecuenciaPago = socio.FrecuenciaDePago.GetDisplayName(),
                FormaPago = socio.FormaPago.GetDisplayName()
            };
        }
        else if (socio.Tipo == TipoSocio.Empresa)
        {
            socioView = new SocioEmpresaViewModel
            {
                NroSocio = socio.Id.ToString(),
                Nombre = socio.Nombre,
                CUIT = socio.DocumentoOCUIT,
                Direccion = socio.Direccion,
                Latitud = socio.Latitud,
                Longitud = socio.Longitud,
                Zona = socio.Zona.GetDisplayName(),
                FechaIngreso = socio.FechaIngreso.ToString("dd/MM/yyyy"),
                Ocupacion = socio.Ocupacion,
                Telefono = socio.Telefono,
                Email = socio.Email,
                CuotaValor = socio.MontoCuota,
                FrecuenciaPago = socio.FrecuenciaDePago.GetDisplayName(),
                FormaPago = socio.FormaPago.GetDisplayName()
            };
        }
    }
}
