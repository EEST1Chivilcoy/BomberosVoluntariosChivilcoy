@using Vista.Data.ViewModels;
@using Vista.Data.ViewModels.Personal;
@using Vista.Data.Models.Salidas;
@using Vista.Data.Models.Personas;
@using Vista.Data.Enums;
@using System.Linq;
@using Vista.Data.Models.Salidas.Componentes;

@inject IMessageService MessageService

<style>

    .damnificados {
        border: 2px solid #ffb366 !important;
        background: linear-gradient(180deg, #fffdf9 0%, #fff7f0 100%);
        box-shadow: 0 4px 12px rgba(255, 163, 77, 0.15);
        border-radius: 16px;
        margin-bottom: 2rem;
        padding: 2.5rem 2rem 2rem 2rem;
        transition: box-shadow 0.25s ease, transform 0.2s ease;
    }



    .damnificados-componente .ant-table {
        background: #fff8f0 !important;
        color: #ff6a33 !important;
        font-weight: 500 !important;
        font-size: 1.05rem !important;
        border-radius: 14px !important;
    }

        .damnificados-componente .ant-table-thead .ant-table-cell,
        .damnificados-componente .ant-table thead th {
            background: linear-gradient(135deg, #ff944d, #ff7a45) !important;
            color: #fff !important;
            font-weight: 600 !important;
            text-align: center !important;
            border-bottom: 2px solid #ffe0cc !important;
            letter-spacing: 0.3px !important;
            padding: 8px 10px !important;
            font-size: 1.02rem !important;
            height: 32px !important;
            min-height: 24px !important;
            line-height: 1.2 !important;
            padding-top: 4px !important;
            padding-bottom: 4px !important;
        }

    .damnificados-componente .ant-table-title {
        background: #fff8f0 !important;
        color: #ff6a33 !important;
        font-weight: 700 !important;
        font-size: 1.05rem !important;
        text-align: left !important;
        padding: 0.5rem 0.8rem !important;
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
        border-bottom: 1px solid #ffd6b3 !important;
    }

    .damnificados-componente .ant-table-cell,
    .damnificados-componente .ant-table td {
        background: #fff !important;
        color: #333 !important;
        padding: 6px 10px !important;
        font-size: 1rem !important;
        height: 12px !important;
    }

    .damnificados-componente .ant-btn {
        font-size: 0.95rem !important;
        padding: 4px 10px !important;
    }

    /* Modal estilo Licencias adaptado para Damnificados */
    .modal-damnificado .ant-modal-content {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(255, 163, 77, 0.15);
        border: 4px solid #ffb366;
        margin-top: -50px;
        margin-bottom: 0px;
        background: linear-gradient(180deg, #fffdf9 0%, #fff7f0 100%);
    }

    .modal-damnificado .ant-modal-header {
        background-color: #fff8f0;
        border-bottom: 1px solid #ffd6b3;
        padding: 16px 24px;
        border-radius: 9px 9px 0 0;
    }

    .modal-damnificado-content {
        padding: 24px;
    }

    .modal-damnificado-form-item {
        margin-bottom: 20px;
        position: relative;
        padding-left: 10px;
    }

        .modal-damnificado-form-item .ant-form-item-label > label,
        .modal-damnificado-form-full-width .ant-form-item-label > label {
            font-weight: 600;
            color: #ff6a33;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: color 0.3s ease;
        }

            .modal-damnificado-form-item .ant-form-item-label > label:hover,
            .modal-damnificado-form-full-width .ant-form-item-label > label:hover {
                color: #ff944d;
            }

    .modal-damnificado .ant-input:focus,
    .modal-damnificado .ant-input:hover,
    .modal-damnificado .ant-select-selector:focus,
    .modal-damnificado .ant-select-selector:hover,
    .modal-damnificado .ant-picker:focus,
    .modal-damnificado .ant-picker:hover,
    .modal-damnificado .ant-picker-input > input:focus,
    .modal-damnificado .ant-picker-input > input:hover,
    .modal-damnificado .ant-input-number-input:focus,
    .modal-damnificado .ant-input-number-input:hover,
    .modal-damnificado .ant-textarea:focus,
    .modal-damnificado .ant-textarea:hover {
        border-color: #ffb366 !important;
        box-shadow: 0 0 0 2px rgba(255, 163, 77, 0.15) !important;
    }

    .modal-damnificado .ant-picker,
    .modal-damnificado .ant-input,
    .modal-damnificado .ant-select-selector,
    .modal-damnificado .ant-input-number,
    .modal-damnificado .ant-textarea {
        border-radius: 8px !important;
        border: 1px solid #ffd6b3 !important;
        background: #fff !important;
        color: #434343 !important;
        transition: all 0.3s ease !important;
    }

    .modal-damnificado .modal-damnificado-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 18px;
        margin-bottom: 0px;
    }

    .modal-damnificado .ant-btn-primary {
        background: linear-gradient(135deg, #ff944d 0%, #ff6a33 100%) !important;
        border: none !important;
        color: #fff !important;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(255, 163, 77, 0.18);
        margin-top: 0;
        margin-bottom: 0;
        padding: 0 20px !important;
    }

        .modal-damnificado .ant-btn-primary:hover {
            background: linear-gradient(135deg, #ff7a45 0%, #ff944d 100%) !important;
            color: #fff !important;
        }

    .btn-nuevo-damnificado {
        background: linear-gradient(135deg, #ff944d 0%, #ff6a33 100%) !important;
        color: #fff !important;
        font-weight: 600;
        border: none !important;
        box-shadow: 0 2px 8px rgba(255, 163, 77, 0.18);
        border-radius: 8px;
        padding: 0 20px !important;
        transition: background 0.3s;
    }

        .btn-nuevo-damnificado:hover {
            background: linear-gradient(135deg, #ff7a45 0%, #ff944d 100%) !important;
            color: #fff !important;
        }
</style>


<div class="damnificados damnificados-componente">
    <Tabs DefaultActiveKey="personas">
        <TabPane Key="personas" Tab="Personas">
            <Table DataSource="Model.Damnificados"
                   Size="TableSize.Small"
                   Class="damnificados-componente"
                   Bordered>
                <TitleTemplate>
                    <GridRow>
                        <GridCol Span="24" Style="text-align: right;">
                            <Button Type="ButtonType.Primary"
                                    Class="btn-nuevo-damnificado"
                                    OnClick="@(() => modalDamnificados = true)">
                                <Icon Type="plus" /> Nuevo Damnificado
                            </Button>
                        </GridCol>
                    </GridRow>
                </TitleTemplate>
                <ColumnDefinitions Context="damnificado">
                    <PropertyColumn Title="N°" Property="d => d.Numero"></PropertyColumn>
                    <PropertyColumn Property="d => d.Nombre"></PropertyColumn>
                    <PropertyColumn Property="d => d.Apellido"></PropertyColumn>
                    <PropertyColumn Property="d => d.Edad"></PropertyColumn>
                    <PropertyColumn Title="Fecha de nacimiento" Property="d => d.FechaDeNacimiento.HasValue ? d.FechaDeNacimiento.Value.ToShortDateString() : string.Empty"></PropertyColumn>
                    <PropertyColumn Property="d => d.Estado"></PropertyColumn>
                    <PropertyColumn Title="Fuerza interviniente" Property="d => d.FuerzaIntervinienteNombre" />
                    <PropertyColumn Title="Hacia dónde fue trasladado" Property="d => d.Destino" />
                    <ActionColumn Title="Acciones">
                        <Popconfirm Title="¿Quieres borrar este damnificado?"
                                    OnConfirm="@(() => EliminarDamnificado(damnificado))"
                                    OkText="Si"
                                    CancelText="No">
                            <Button Danger>
                                <Icon Type="delete" />
                            </Button>
                        </Popconfirm>
                        <Button Type="@ButtonType.Primary" OnClick="@(() => EditarDamnificado(damnificado))">
                            <Icon Type="edit" />
                        </Button>
                    </ActionColumn>
                </ColumnDefinitions>
            </Table>

            <Modal @bind-Visible="modalDamnificados"
                   Title="@(editandoDamnificado ? "Editar damnificado" : "Datos del damnificado")"
                   OkText="@(editandoDamnificado ? "Editar" : "Agregar")"
                   CancelText="@("Cancelar")"
                   OnOk="@AgregarEditarDamnificado"
                   OnCancel="@(() => {editandoDamnificado = false; Damnificado = new();})"
                   WrapClassName="modal-damnificado">
                <div class="modal-damnificado-content">
                    <Form Model="Damnificado" Layout="FormLayout.Vertical" Class="modal-damnificado-form">
                        <Row Gutter="16">
                            <AntDesign.Col Span="8">
                                <FormItem Label="Nombre" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Damnificado.Nombre" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="8">
                                <FormItem Label="Apellido" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Damnificado.Apellido" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="8">
                                <FormItem Label="Documento" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Damnificado.Dni" />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                        <Row Gutter="16">
                            <AntDesign.Col Span="8">
                                <FormItem Label="Sexo" Class="modal-damnificado-form-item">
                                    <EnumSelect TEnum="TipoSexo ?" @bind-Value="@Damnificado.Sexo" AllowClear />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="10">
                                <FormItem Label="Fecha de nacimiento" Class="modal-damnificado-form-item">
                                    <DatePicker TValue="DateTime ?" @bind-Value="@Damnificado.FechaDeNacimiento" OnChange="@CalcularEdad" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="6">
                                <FormItem Label="Edad" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Damnificado.Edad" Disabled="@Damnificado.FechaDeNacimiento.HasValue" />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                        <Row Gutter="16">
                            <AntDesign.Col Span="14">
                                <FormItem Label="Lugar de nacimiento" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Damnificado.LugarDeNacimiento" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="10">
                                <FormItem Label="Estado" Class="modal-damnificado-form-item">
                                    <EnumSelect TEnum="TipoDamnificado ?" @bind-Value="@Damnificado.Estado" AllowClear />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                        <Row Gutter="16">
                            <AntDesign.Col Span="12">
                                <FormItem Label="Fuerza que lo trasladó" Class="modal-damnificado-form-item">
                                    <Select TItem="FuerzaIntervinienteViewModel"
                                            TItemValue="int?"
                                            DataSource="@Model.FuerzasIntervinientes"
                                            @bind-Value="@Damnificado.FuerzaIntervinienteId"
                                            ValueName="@nameof(FuerzaIntervinienteViewModel.Id)"
                                            ItemLabel="f => f.NombreCompleto"
                                            Placeholder="Seleccione la fuerza que lo trasladó"
                                            AllowClear="true"
                                            EnableSearch="true"
                                            OnSelectedItemChanged="OnFuerzaSeleccionada">
                                    </Select>
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="12">
                                <FormItem Label="¿Hacia dónde?" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Damnificado.Destino" />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                    </Form>
                </div>
            </Modal>
        </TabPane>
        <TabPane Key="vehiculos" Tab="Vehículos">
            <Table DataSource="Model.VehiculosDamnificados"
                   Size="TableSize.Small"
                   Class="damnificados-componente"
                   Bordered>
                <TitleTemplate>
                    <GridRow>
                        <GridCol Span="24" Style="text-align: right;">
                            <Button Type="ButtonType.Primary"
                                    Class="btn-nuevo-damnificado"
                                    OnClick="@(() => modalVehiculo = true)">
                                <Icon Type="plus" /> Nuevo Vehiculo
                            </Button>
                        </GridCol>
                    </GridRow>
                </TitleTemplate>
                <ColumnDefinitions Context="vehiculo">
                    <PropertyColumn Title="N°" Property="v => v.Numero"></PropertyColumn>
                    <PropertyColumn Property="v => v.Tipo"></PropertyColumn>
                    <PropertyColumn Property="v => v.Marca"></PropertyColumn>
                    <PropertyColumn Property="v => v.Modelo"></PropertyColumn>
                    <PropertyColumn Property="v => v.Año"></PropertyColumn>
                    <PropertyColumn Property="v => v.Patente"></PropertyColumn>
                    <PropertyColumn Property="v => v.Color"></PropertyColumn>
                    <PropertyColumn Property="v => v.Observaciones"></PropertyColumn>
                    <PropertyColumn Title="¿Se activó el Airbag?" Property="@(v => v.Airbag ? "Si" : "No")"></PropertyColumn>
                    <PropertyColumn Title="Dueño" Property="v => v.Dueño"></PropertyColumn>
                    <PropertyColumn Title="Seguro" Property="v => v.CompañiaAseguradora"></PropertyColumn>
                    <PropertyColumn Title="Poliza" Property="v => v.NumeroDePoliza"></PropertyColumn>
                    <PropertyColumn Title="Vencimiento" Property="v => v.FechaDeVencimiento.HasValue ? v.FechaDeVencimiento.Value.ToShortDateString() : string.Empty"></PropertyColumn>
                    <PropertyColumn Title="Conductor" Property="@(v => v.Conductor != null ? v.Conductor.NombreYApellido : "Sin conductor")"></PropertyColumn>
                    <PropertyColumn Title="Pasajeros" Property="@(v => ObtenerPasajerosTexto(v))"></PropertyColumn>
                    <ActionColumn Title="Acciones">
                        <Popconfirm Title="¿Quieres borrar este vehículo?"
                                    OnConfirm="@(() => EliminarVehiculo(vehiculo))"
                                    OkText="Si"
                                    CancelText="No">
                            <Button Danger>
                                <Icon Type="delete" />
                            </Button>
                        </Popconfirm>
                        <Button Type="@ButtonType.Primary" OnClick="@(() => EditarVehiculo(vehiculo))">
                            <Icon Type="edit" />
                        </Button>
                    </ActionColumn>
                </ColumnDefinitions>
            </Table>

            <Modal @bind-Visible="modalVehiculo"
                   Title="@(editandoVehiculo ? "Editar vehiculo" : "Datos del vehiculo")"
                   OkText="@(editandoVehiculo ? "Editar" : "Agregar")"
                   CancelText="@("Cancelar")"
                   OnOk="@AgregarEditarVehiculo"
                   OnCancel="@(() => {editandoVehiculo = false; Vehiculo = new();})"
                   WrapClassName="modal-damnificado">
                <div class="modal-damnificado-content">
                    <Form Model="Vehiculo" Layout="FormLayout.Vertical" Class="modal-damnificado-form">
                        <Row Gutter="16">
                            <AntDesign.Col Span="8">
                                <FormItem Label="Marca" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.Marca" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="8">
                                <FormItem Label="Modelo" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.Modelo" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="8">
                                <FormItem Label="Año" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.Año" />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                        <Row Gutter="16">
                            <AntDesign.Col Span="8">
                                <FormItem Label="Patente" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.Patente" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="8">
                                <FormItem Label="Tipo" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.Tipo" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="8">
                                <FormItem Label="Color" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.Color" />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                        <Row Gutter="16">
                            <AntDesign.Col Span="14">
                                <FormItem Label="Observaciones" Class="modal-damnificado-form-item">
                                    <TextArea @bind-Value="@Vehiculo.Observaciones" Rows="3" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="10">
                                <FormItem Label="¿Se activó el Airbag?" Class="modal-damnificado-form-item">
                                    <Switch @bind-Checked="@Vehiculo.Airbag" />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                        <Row Gutter="16">
                            <AntDesign.Col Span="12">
                                <FormItem Label="Dueño (Nombre y Apellido)" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.Dueño" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="12">
                                <FormItem Label="Compañia Aseguradora" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.CompañiaAseguradora" />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                        <Row Gutter="16">
                            <AntDesign.Col Span="12">
                                <FormItem Label="Numero de Poliza" Class="modal-damnificado-form-item">
                                    <Input @bind-Value="@Vehiculo.NumeroDePoliza" />
                                </FormItem>
                            </AntDesign.Col>
                            <AntDesign.Col Span="12">
                                <FormItem Label="Fecha de Vencimiento" Class="modal-damnificado-form-item">
                                    <DatePicker TValue="DateTime ?" @bind-Value="@Vehiculo.FechaDeVencimiento" />
                                </FormItem>
                            </AntDesign.Col>
                        </Row>
                        @if (Model.Damnificados != null && Model.Damnificados.Any())
                        {
                            <Row Gutter="16">
                                <AntDesign.Col Span="12">
                                    <FormItem Label="¿Se conoce el conductor?" Class="modal-damnificado-form-item">
                                        <Switch @bind-Checked="@Vehiculo.SeConoceConductor" />
                                    </FormItem>
                                </AntDesign.Col>
                                @if (Vehiculo.SeConoceConductor)
                                {
                                    <AntDesign.Col Span="12">
                                        <FormItem Label="Conductor" Class="modal-damnificado-form-item">
                                            <Select TItem="DamnificadoViewModel"
                                                    TItemValue="int?"
                                                    DataSource="@Model.Damnificados"
                                                    @bind-Value="@Vehiculo.ConductorId"
                                                    ValueName="@nameof(DamnificadoViewModel.Numero)"
                                                    ItemLabel="c => c.NombreYApellido"
                                                    Placeholder="Seleccione el conductor"
                                                    AllowClear="true"
                                                    EnableSearch="true"
                                                    OnSelectedItemChanged="OnConductorSeleccionado">
                                            </Select>
                                        </FormItem>
                                    </AntDesign.Col>
                                }
                            </Row>
                            <Row Gutter="16">
                                <AntDesign.Col Span="24">
                                    <FormItem Label="Pasajeros" Class="modal-damnificado-form-item">
                                        <Select Mode="SelectMode.Multiple"
                                                TItem="DamnificadoViewModel"
                                                TItemValue="int"
                                                DataSource="@ObtenerDamnificadosDisponibles()"
                                                @bind-Values="@PasajerosSeleccionados"
                                                ValueName="@nameof(DamnificadoViewModel.Numero)"
                                                ItemLabel="p => p.NombreYApellido"
                                                Placeholder="Seleccione los Pasajeros"
                                                AllowClear="true"
                                                EnableSearch="true">
                                        </Select>
                                    </FormItem>
                                </AntDesign.Col>
                            </Row>
                        }
                    </Form>
                </div>
            </Modal>
        </TabPane>
    </Tabs>
</div>

@code {
    [Parameter] public required SalidasViewModels Model { get; set; }

    private DamnificadoViewModel Damnificado = new DamnificadoViewModel();
    private VehiculoDamnificadoViewModel Vehiculo = new VehiculoDamnificadoViewModel();
    private bool modalDamnificados = false, modalVehiculo = false;
    private bool editandoDamnificado = false, editandoVehiculo = false;

    private string ObtenerPasajerosTexto(VehiculoDamnificadoViewModel vehiculo)
    {
        if (vehiculo.Pasajeros != null && vehiculo.Pasajeros.Any())
            return string.Join(", ", vehiculo.Pasajeros.Select(p => p.NombreYApellido));
        else
            return "Sin pasajeros";
    }

    private async Task EliminarDamnificado(DamnificadoViewModel damnificado)
    {
        var damnificadoAEliminar = Model.Damnificados.SingleOrDefault(d => d.Numero == damnificado.Numero);

        if (damnificadoAEliminar == null)
        {
            MessageService.Error("Damnificado no encontrado");
            return;
        }

        if (Model.VehiculosDamnificados != null && Model.VehiculosDamnificados.Any())
        {
            foreach (var vehiculo in Model.VehiculosDamnificados)
            {
                if (vehiculo.Conductor != null && vehiculo.Conductor.Numero == damnificadoAEliminar.Numero)
                {
                    vehiculo.Conductor = null;
                    vehiculo.ConductorId = null;
                }
                if (vehiculo.Pasajeros != null && vehiculo.Pasajeros.Any(p => p.Numero == damnificadoAEliminar.Numero))
                {
                    vehiculo.Pasajeros = vehiculo.Pasajeros.Where(p => p.Numero != damnificadoAEliminar.Numero).ToList();
                }
            }
        }

        Model.Damnificados.Remove(damnificadoAEliminar);

        for (int i = 0; i < Model.Damnificados.Count; i++)
        {
            Model.Damnificados[i].Numero = i + 1;
        }

        MessageService.Success("Damnificado eliminado correctamente");
    }

    private async Task EliminarVehiculo(VehiculoDamnificadoViewModel vehiculo)
    {
        var vehiculoAEliminar = Model.VehiculosDamnificados.SingleOrDefault(v => v.Numero == vehiculo.Numero);

        if (vehiculoAEliminar == null)
        {
            MessageService.Error("Vehiculo no encontrado");
            return;
        }

        Model.VehiculosDamnificados.Remove(vehiculoAEliminar);

        for (int i = 0; i < Model.VehiculosDamnificados.Count; i++)
        {
            Model.VehiculosDamnificados[i].Numero = i + 1;
        }

        MessageService.Success("Vehiculo eliminado correctamente");
    }

    private void EditarDamnificado(DamnificadoViewModel damnificado)
    {
        Damnificado = damnificado.Clonar();
        editandoDamnificado = true;
        modalDamnificados = true;
    }

    private void AgregarEditarDamnificado()
    {
        try
        {
            if (!editandoDamnificado)
            {
                Damnificado.Numero = Model.Damnificados.Count + 1;
                Model.Damnificados.Add(Damnificado);
                MessageService.Success("Damnificado agregado correctamente");
            }
            else
            {
                var damnificadoAEditar = Model.Damnificados.SingleOrDefault(d => d.Numero == Damnificado.Numero);

                if (damnificadoAEditar == null)
                {
                    MessageService.Error("Damnificado no encontrado");
                    return;
                }

                damnificadoAEditar.ActualizarDesde(Damnificado);
                MessageService.Success("Damnificado actualizado correctamente");
                editandoDamnificado = false;
            }

            modalDamnificados = false;
            Damnificado = new DamnificadoViewModel();
        }
        catch (Exception e)
        {
            StateHasChanged();
            if (e.InnerException != null)
                MessageService.Error(e.InnerException.Message, 5);
            else
                MessageService.Error(e.Message, 5);
        }
    }

    private void EditarVehiculo(VehiculoDamnificadoViewModel vehiculo)
    {
        Vehiculo = vehiculo.Clonar();
        editandoVehiculo = true;
        modalVehiculo = true;
    }

    private void AgregarEditarVehiculo()
    {
        try
        {
            if (!editandoVehiculo)
            {
                Vehiculo.Numero = Model.VehiculosDamnificados.Count + 1;
                Model.VehiculosDamnificados.Add(Vehiculo);
                MessageService.Success("Vehiculo agregado correctamente");
            }
            else
            {
                var vehiculoAEditar = Model.VehiculosDamnificados.SingleOrDefault(v => v.Numero == Vehiculo.Numero);

                if (vehiculoAEditar == null)
                {
                    MessageService.Error("Vehiculo no encontrado");
                    return;
                }

                vehiculoAEditar.ActualizarDesde(Vehiculo);
                MessageService.Success("Vehiculo actualizado correctamente");
                editandoVehiculo = false;
            }
            modalVehiculo = false;
            Vehiculo = new VehiculoDamnificadoViewModel();
        }
        catch (Exception e)
        {
            StateHasChanged();
            if (e.InnerException != null)
                MessageService.Error(e.InnerException.Message, 5);
            else
                MessageService.Error(e.Message, 5);
        }
    }

    private void CalcularEdad()
    {
        if (Damnificado.FechaDeNacimiento.HasValue)
            Damnificado.Edad = (int)((DateTime.Now - Damnificado.FechaDeNacimiento.Value).TotalDays / 365.25);
        else
            Damnificado.Edad = null;
    }

    private void OnConductorSeleccionado(DamnificadoViewModel conductor)
    {
        if (conductor != null)
        {
            Vehiculo.Conductor = conductor;
            if (Vehiculo.Pasajeros != null && Vehiculo.Pasajeros.Any(p => p.Numero == conductor.Numero))
            {
                Vehiculo.Pasajeros = Vehiculo.Pasajeros.Where(p => p.Numero != conductor.Numero).ToList();
            }
        }
        else
            Vehiculo.Conductor = null;
    }

    private IEnumerable<int> PasajerosSeleccionados
    {
        get => Vehiculo.Pasajeros?.Select(p => p.Numero) ?? Enumerable.Empty<int>();
        set
        {
            Vehiculo.Pasajeros = (value != null && value.Any())
                ? Model.Damnificados.Where(d => value.Contains(d.Numero)).ToList()
                : new List<DamnificadoViewModel>();
        }
    }

    private IEnumerable<DamnificadoViewModel> ObtenerDamnificadosDisponibles()
    {
        if (Vehiculo.Conductor == null)
            return Model.Damnificados;
        else
            return Model.Damnificados.Where(d => d.Numero != Vehiculo.Conductor.Numero);
    }

    private void OnFuerzaSeleccionada(FuerzaIntervinienteViewModel fuerza)
    {
        if (fuerza != null)
            Damnificado.FuerzaInterviniente = fuerza;
        else
            Damnificado.FuerzaInterviniente = null;
    }
}
