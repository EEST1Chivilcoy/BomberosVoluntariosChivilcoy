@using AntDesign.TableModels
@using Vista.Pages.Licencias.Componentes
@using Vista.Data.Models.Personas.Personal
@using Vista.Data.Models.Personas.Personal.Componentes
@using Vista.Data.Mappers

@*Servicios utilizados*@
@using Vista.Services;
@inject ILicenciaService LicenciaService
@inject IMessageService MessageService
@inject IBomberoService BomberoService

@page "/licencias"

<style>
    /* Variables CSS para colores principales - Prefijo para evitar conflictos */
    .licencias-abm {
        --abm-primary-color: #A63333;
        --abm-primary-dark: #732D2D;
        --abm-success-color: #4CAF50;
        --abm-success-dark: #438E46;
        --abm-warning-color: #F57F17;
        --abm-warning-light: #FFF8E1;
        --abm-error-color: #C62828;
        --abm-error-light: #FFEBEE;
        --abm-approved-color: #2E7D32;
        --abm-approved-light: #E6F7E9;
        --abm-gold-color: #FFD700;
    }

        /* Contenedor principal con scope específico */
        .licencias-abm .licenses-container {
            padding: 12px !important;
            min-height: 100vh !important;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;
        }

        /* Card principal con efecto glassmorphism */
        .licencias-abm .main-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 16px !important;
            box-shadow: 0 8px 32px rgba(166, 51, 51, 0.1), 0 4px 16px rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            overflow: hidden !important;
        }

    /* Header animado tipo Incidentes */
    .licencias-abm .header-section {
        background: linear-gradient(135deg, #A63333 0%, #732D2D 100%) !important;
        color: white !important;
        padding: 28px !important;
        position: relative !important;
        overflow: hidden !important;
    }

    /* Lava lamp bubbles background for header */
    .licencias-abm .header-section::before {
        content: '';
        display: none;
    }
    .licencias-abm .header-section .lava-bubbles {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
    }
    .licencias-abm .header-section .lava-bubble {
        position: absolute;
        border-radius: 50%;
        opacity: 0.45;
        background: radial-gradient(circle at 60% 40%, #FFD54F 0%, #F9A825 80%, transparent 100%);
        animation: lava-bubble-move 8s linear infinite;
        filter: blur(1.5px);
        mix-blend-mode: lighten;
    }
    .licencias-abm .header-section .lava-bubble.b1 {
        left: 10%; width: 60px; height: 60px; bottom: -70px;
        animation-delay: 0s;
        animation-duration: 7.5s;
    }
    .licencias-abm .header-section .lava-bubble.b2 {
        left: 35%; width: 90px; height: 90px; bottom: -100px;
        animation-delay: 2s;
        animation-duration: 9s;
        background: radial-gradient(circle at 60% 40%, #FFEB3B 0%, #FFD54F 80%, transparent 100%);
    }
    .licencias-abm .header-section .lava-bubble.b3 {
        left: 65%; width: 50px; height: 50px; bottom: -60px;
        animation-delay: 1.5s;
        animation-duration: 6.5s;
        background: radial-gradient(circle at 60% 40%, #FFFDE7 0%, #FFD54F 80%, transparent 100%);
    }
    .licencias-abm .header-section .lava-bubble.b4 {
        left: 80%; width: 70px; height: 70px; bottom: -80px;
        animation-delay: 3.2s;
        animation-duration: 8.5s;
        background: radial-gradient(circle at 60% 40%, #F9A825 0%, #FFD54F 80%, transparent 100%);
    }
    .licencias-abm .header-section .lava-bubble.b5 {
        left: 55%; width: 40px; height: 40px; bottom: -50px;
        animation-delay: 5s;
        animation-duration: 7.2s;
        background: radial-gradient(circle at 60% 40%, #FFFDE7 0%, #F9A825 80%, transparent 100%);
    }

    @@keyframes lava-bubble-move {
        0% {
            transform: translateY(0) scale(1) rotate(0deg);
            opacity: 0.45;
        }
        60% {
            opacity: 0.7;
            filter: blur(2.5px);
        }
        80% {
            transform: translateY(-220px) scale(1.15) rotate(10deg);
            opacity: 0.6;
        }
        100% {
            transform: translateY(-320px) scale(0.95) rotate(-8deg);
            opacity: 0;
        }
    }

    .licencias-abm .main-title {
        font-family: 'Poppins', 'Fjalla One', sans-serif !important;
        font-size: 2.2rem !important;
        font-weight: 700 !important;
        letter-spacing: 1px !important;
        margin: 0 !important;
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        animation: text-glow 2.5s ease-in-out infinite alternate !important;
        position: relative !important;
        z-index: 2 !important;
    }

    .licencias-abm .title-icon {
        color: #FFD54F !important;
        font-size: 2rem !important;
        filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.25)) !important;
    }

    @@keyframes text-glow {
        0%, 100% { text-shadow: 0 0 5px #F9A825, 0 0 10px #FFD54F; }
        50% { text-shadow: 0 0 12px #F9A825, 0 0 22px #FFD54F; }
    }

    .licencias-abm .title-container {
        position: relative !important;
        z-index: 2 !important;
        margin-bottom: 20px !important;
    }

    /* Filtros responsivos */
    .licencias-abm .filters-section {
        position: relative !important;
        z-index: 2 !important;
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }

    .licencias-abm .filter-row {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
        gap: 16px !important;
        align-items: end !important;
    }

    .licencias-abm .filter-group {
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
    }

    .licencias-abm .filter-label {
        font-weight: 600 !important;
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 0.9rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
    }

    .licencias-abm .actions-row {
        display: grid !important;
        grid-template-columns: 1fr auto auto !important;
        gap: 16px !important;
        align-items: center !important;
    }

    .licencias-abm .search-container {
        min-width: 0 !important;
    }

    /* Botones modernos */
    .licencias-abm .modern-button {
        height: 40px !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        position: relative !important;
        overflow: hidden !important;
    }

    .licencias-abm .add-button {
        background: linear-gradient(135deg, var(--abm-success-color) 0%, var(--abm-success-dark) 100%) !important;
        border: none !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3) !important;
        padding: 0 20px !important;
    }

        .licencias-abm .add-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4) !important;
        }

    /* Badge de notificaciones */
    .licencias-abm .notification-button {
        background: rgba(255, 255, 255, 0.2) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        color: white !important;
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        transition: all 0.3s ease !important;
    }

        .licencias-abm .notification-button:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            transform: scale(1.1) !important;
        }

    /* Tabla responsive */
    .licencias-abm .table-container {
        padding: 0 !important;
        overflow: hidden !important;
    }

    /* Estados de licencia */
    .licencias-abm .status-badge {
        padding: 6px 12px !important;
        border-radius: 20px !important;
        font-weight: 600 !important;
        text-align: center !important;
        font-size: 0.85rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
    }

    .licencias-abm .status-approved {
        background: var(--abm-approved-light) !important;
        color: var(--abm-approved-color) !important;
    }

    .licencias-abm .status-pending {
        background: var(--abm-warning-light) !important;
        color: var(--abm-warning-color) !important;
    }

    .licencias-abm .status-rejected {
        background: var(--abm-error-light) !important;
        color: var(--abm-error-color) !important;
    }

    /* Filas de tabla con colores de estado - Scoped to ABM table */
    .licencias-abm :deep(.ant-table-tbody > tr.Aprobada > td) {
        background-color: rgba(46, 125, 50, 0.02) !important;
        border-left: 3px solid var(--abm-approved-color) !important;
    }

    .licencias-abm :deep(.ant-table-tbody > tr.Pendiente > td) {
        background-color: rgba(245, 127, 23, 0.02) !important;
        border-left: 3px solid var(--abm-warning-color) !important;
    }

    .licencias-abm :deep(.ant-table-tbody > tr.Rechazada > td) {
        background-color: rgba(198, 40, 40, 0.02) !important;
        border-left: 3px solid var(--abm-error-color) !important;
    }

    .licencias-abm :deep(.ant-table-tbody > tr:hover > td) {
        background-color: rgba(166, 51, 51, 0.05) !important;
        cursor: pointer !important;
        transform: translateX(4px) !important;
        transition: all 0.2s ease !important;
    }

    /* Estilos de tabla personalizados - Scoped */
    .licencias-abm :deep(.ant-table-thead > tr > th) {
        background: linear-gradient(135deg, var(--abm-primary-color) 0%, var(--abm-primary-dark) 100%) !important;
        color: white !important;
        font-weight: 600 !important;
        border: none !important;
        padding: 16px !important;
    }

    .licencias-abm :deep(.ant-table-cell) {
        padding: 16px !important;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06) !important;
    }

    .licencias-abm :deep(.ant-table) {
        border-radius: 0 !important;
    }

    /* Modal responsivo */
    .licencias-abm .modal-content {
        max-height: 80vh !important;
        overflow-y: auto !important;
    }

    .licencias-abm .form-grid {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }

    .licencias-abm .form-row {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 16px !important;
    }

    .licencias-abm .form-full-width {
        grid-column: 1 / -1 !important;
    }

    /* Detalles del modal */
    .licencias-abm .detail-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
        gap: 20px !important;
        margin-bottom: 24px !important;
    }

    .licencias-abm .detail-item {
        background: #f8f9fa !important;
        padding: 16px !important;
        border-radius: 8px !important;
        border: 1px solid #e9ecef !important;
        transition: all 0.3s ease !important;
    }

        .licencias-abm .detail-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            transform: translateY(-2px) !important;
        }

    .licencias-abm .detail-label {
        font-weight: 700 !important;
        color: var(--abm-primary-color) !important;
        font-size: 0.8rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        margin-bottom: 8px !important;
    }

    .licencias-abm .detail-value {
        font-size: 1rem !important;
        color: #333 !important;
        word-break: break-word !important;
    }

    .licencias-abm .detail-description {
        grid-column: 1 / -1 !important;
    }

        .licencias-abm .detail-description .detail-value {
            min-height: 60px !important;
            line-height: 1.5 !important;
        }

    /* Loading states */
    .licencias-abm .loading-spinner {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        padding: 40px !important;
        font-size: 1.2rem !important;
        color: var(--abm-primary-color) !important;
    }

    /* Animaciones */
    .licencias-abm .fade-in {
        animation: abm-fadeIn 0.5s ease-in-out !important;
    }

    @@keyframes abm-fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Mejoras para inputs dentro del ABM */
    .licencias-abm :deep(.ant-picker),
    .licencias-abm :deep(.ant-select-selector),
    .licencias-abm :deep(.ant-input) {
        border-radius: 8px !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        background: rgba(255, 255, 255, 0.1) !important;
        color: white !important;
        transition: all 0.3s ease !important;
    }

    .licencias-abm :deep(.ant-picker:hover),
    .licencias-abm :deep(.ant-select-selector:hover),
    .licencias-abm :deep(.ant-input:hover) {
        background: rgba(255, 255, 255, 0.2) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
    }

    .licencias-abm :deep(.ant-picker-input > input),
    .licencias-abm :deep(.ant-select-selection-item),
    .licencias-abm :deep(.ant-input::placeholder) {
        color: white !important;
    }

    /* Responsive breakpoints específicos para ABM */
    @@media (max-width: 1199px) {
        .licencias-abm .licenses-container {
            padding: 8px !important;
        }

        .licencias-abm .header-section {
            padding: 20px !important;
        }

        .licencias-abm .main-title {
            font-size: 2rem !important;
            flex-direction: column !important;
            text-align: center !important;
            gap: 8px !important;
        }

        .licencias-abm .filter-row {
            grid-template-columns: 1fr !important;
        }

        .licencias-abm .actions-row {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
        }

        .licencias-abm .form-row {
            grid-template-columns: 1fr !important;
        }

        .licencias-abm .detail-grid {
            grid-template-columns: 1fr !important;
        }
    }

    @@media (max-width: 767px) {
        .licencias-abm .licenses-container {
            padding: 4px !important;
        }

        .licencias-abm .header-section {
            padding: 16px !important;
        }

        .licencias-abm .main-title {
            font-size: 1.8rem !important;
            letter-spacing: 2px !important;
        }
        /* Ocultar columnas menos importantes en móvil */
        .licencias-abm :deep(.ant-table-cell:nth-child(3)),
        .licencias-abm :deep(.ant-table-cell:nth-child(4)) {
            display: none !important;
        }
    }

    @@media (max-width: 575px) {
        .licencias-abm .main-title {
            font-size: 1.5rem !important;
        }

        .licencias-abm .modern-button {
            height: 36px !important;
            padding: 0 12px !important;
        }
        /* Solo mostrar columnas esenciales */
        .licencias-abm :deep(.ant-table-cell:nth-child(n+4)) {
            display: none !important;
        }

        .licencias-abm :deep(.ant-table-cell:nth-child(1)),
        .licencias-abm :deep(.ant-table-cell:nth-child(2)),
        .licencias-abm :deep(.ant-table-cell:nth-child(6)) {
            display: table-cell !important;
        }
    }
</style>

<div class="licencias-abm">
    <div class="licenses-container fade-in">
        <Card Class="main-card">
            <div class="header-section">
                <div class="lava-bubbles">
                    <div class="lava-bubble b1"></div>
                    <div class="lava-bubble b2"></div>
                    <div class="lava-bubble b3"></div>
                    <div class="lava-bubble b4"></div>
                    <div class="lava-bubble b5"></div>
                </div>
                <div class="title-container">
                    <h1 class="main-title">
                        <Icon Type="key" Class="title-icon" />
                        GESTIÓN DE LICENCIAS
                    </h1>
                </div>
                <div class="filters-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">📅 Fecha Desde</label>
                            <DatePicker TValue="DateTime"
                                        DefaultValue="@DateTime.Now.AddDays(-30)"
                                        @bind-Value="@FechaBuscarI"
                                        Size="InputSize.Large"
                                        Placeholder="@("Seleccionar fecha")" />
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">📅 Fecha Hasta</label>
                            <DatePicker TValue="DateTime"
                                        DefaultValue="@DateTime.Now.AddDays(30)"
                                        @bind-Value="@FechaBuscarF"
                                        Size="InputSize.Large"
                                        Placeholder="@("Seleccionar fecha")" />
                        </div>
                    </div>

                    <div class="actions-row">
                        <div class="search-container">
                            <Search Placeholder="🔍 Buscar por nombre, legajo o descripción..."
                                    AllowClear
                                    EnterButton="true"
                                    Size="InputSize.Large"
                                    OnSearch="@(() => LicenciasVM = FiltrarLicencias())"
                                    @bind-Value="Busqueda" />
                        </div>

                        <Button Class="modern-button add-button"
                                OnClick="@(() => _modalAñadirVisible = true)"
                                Icon="plus"
                                Size="ButtonSize.Large">
                            Nueva Licencia
                        </Button>

                        <Dropdown Trigger="@(new Trigger[] { Trigger.Click })"
                                  Placement="Placement.BottomRight"
                                  Arrow>
                            <Overlay>
                                <div style="min-width: 520px; max-width: 90vw;">
                                    <LicenciasAprobar OnCompleted="@Init" />
                                </div>
                            </Overlay>
                            <ChildContent>
                                <Badge Count="@LicenciasVM_PendientesDeAprobacion" ShowZero="false">
                                    <Button Class="notification-button" Shape="ButtonShape.Circle" Size="ButtonSize.Large">
                                        <Icon Type="bell" />
                                    </Button>
                                </Badge>
                            </ChildContent>
                        </Dropdown>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <Table DataSource="LicenciasVM"
                       PageSize="10"
                       Responsive
                       TItem="LicenciaViewModel"
                       RowClassName="@(c => c.Data.EstadoLicencia.ToString())"
                       OnRow="@OnRowClick"
                       Loading="@_loading"
                       ScrollX="800px">

                    <ColumnDefinitions Context="licencia">
                        <PropertyColumn Title="👤 Bombero"
                                        Property="c => c.ApellidoYNombre"
                                        Sortable
                                        Width="250px"
                                        Fixed="ColumnFixPlacement.Left" />

                        <PropertyColumn Title="📋 Legajo"
                                        Property="c => c.NumeroLegajo"
                                        Sortable
                                        Width="100px" />

                        <PropertyColumn Title="📅 Inicio"
                                        Property="c => c.Desde"
                                        Format="dd/MM/yyyy"
                                        Sortable
                                        DefaultSortOrder="SortDirection.Descending"
                                        Width="120px" />

                        <PropertyColumn Title="📅 Fin"
                                        Property="c => c.Hasta"
                                        Format="dd/MM/yyyy"
                                        Sortable
                                        Width="120px" />

                        <PropertyColumn Title="⏱️ Duración"
                                        Property="c => c.DuracionEnDias"
                                        Sortable
                                        Width="120px">
                            <Template>
                                @{
                                    string bgColor = licencia.EstadoLicencia switch
                                    {
                                        TipoEstadoLicencia.Rechazada => "var(--abm-error-light)",
                                        TipoEstadoLicencia.Aprobada => "var(--abm-approved-light)",
                                        _ => "var(--abm-warning-light)"
                                    };
                                    string textColor = licencia.EstadoLicencia switch
                                    {
                                        TipoEstadoLicencia.Rechazada => "var(--abm-error-color)",
                                        TipoEstadoLicencia.Aprobada => "var(--abm-approved-color)",
                                        _ => "var(--abm-warning-color)"
                                    };
                                }
                                <Tag Color="@textColor" Style="@($"background-color: {bgColor}; border-color: {textColor}; font-weight: 600;")">
                                    @licencia.DuracionEnDias días
                                </Tag>
                            </Template>
                        </PropertyColumn>

                        <PropertyColumn Title="🏷️ Tipo"
                                        Property="@(c => c.TipoLicencia.GetDisplayName())"
                                        Sortable
                                        Width="200px" />

                        <PropertyColumn Title="📊 Estado"
                                        Property="c => c.EstadoLicencia"
                                        Sortable
                                        Width="150px"
                                        Fixed="ColumnFixPlacement.Right">
                            <Template>
                                @{
                                    string statusClass = licencia.EstadoLicencia switch
                                    {
                                        TipoEstadoLicencia.Rechazada => "status-rejected",
                                        TipoEstadoLicencia.Aprobada => "status-approved",
                                        _ => "status-pending"
                                    };
                                    string icon = licencia.EstadoLicencia switch
                                    {
                                        TipoEstadoLicencia.Rechazada => "close-circle",
                                        TipoEstadoLicencia.Aprobada => "check-circle",
                                        _ => "clock-circle"
                                    };
                                }
                                <Space>
                                    <Icon Type="@icon" />
                                    <span class="status-badge @statusClass">
                                        @licencia.EstadoLicencia.ToString()
                                    </span>
                                </Space>
                            </Template>
                        </PropertyColumn>
                    </ColumnDefinitions>
                </Table>
            </div>
        </Card>
    </div>
</div>

@* Modal para añadir licencia - Rediseñado responsivo *@
<Modal @bind-Visible="_modalAñadirVisible"
       Title="➕ Nueva Licencia"
       Width="@("90%")"
       Style="max-width: 800px;"
       OkText="@("Crear Licencia")"
       CancelText="@("Cancelar")"
       OnOk="@AddLicencia"
       DestroyOnClose>
    <div class="licencias-abm">
        <div class="modal-content">
            <Form Model="nuevaLicencia" Layout="FormLayout.Vertical">
                <div class="form-grid">
                    <div class="form-row">
                        <FormItem Label="👤 Bombero" Required>
                            <Select TItem="BomberoViweModel"
                                    TItemValue="int"
                                    DataSource="@BomberosVM"
                                    Value="nuevaLicencia.PersonaId"
                                    ValueChanged="OnBomberoChanged"
                                    LabelName="@nameof(BomberoViweModel.NombreYApellido)"
                                    ValueName="@nameof(BomberoViweModel.Id)"
                                    Placeholder="Seleccione el bombero"
                                    AllowClear
                                    EnableSearch
                                    Size="InputSize.Large" />
                        </FormItem>

                        <FormItem Label="📋 Número Legajo">
                            <AntDesign.InputNumber @bind-Value="nuevaLicencia.NumeroLegajo"
                                                   Disabled
                                                   Size="InputSize.Large" />
                        </FormItem>
                    </div>

                    <FormItem Label="🏷️ Tipo de Licencia" Required>
                        <EnumSelect TEnum="TipoLicencia?"
                                    @bind-Value="@nuevaLicencia.TipoLicencia"
                                    AllowClear
                                    Placeholder="Seleccione el tipo de licencia"
                                    Size="InputSize.Large" />
                    </FormItem>

                    @if (nuevaLicencia.TipoLicencia == TipoLicencia.RazonesDeSalud)
                    {
                        <FormItem Label="📎 Certificado Médico">
                            <Upload Accept=".pdf,.jpg,.png,.jpeg"
                                    MaxCount="1"
                                    ShowUploadList>
                                <Button Icon="upload">Adjuntar Certificado</Button>
                            </Upload>
                        </FormItem>
                    }

                    <FormItem Label="📝 Descripción" Class="form-full-width">
                        <TextArea @bind-Value="@nuevaLicencia.Descripcion"
                                  Placeholder="Ingrese una descripción detallada de la licencia"
                                  Rows="4"
                                  ShowCount
                                  MaxLength="500" />
                    </FormItem>

                    <div class="form-row">
                        <FormItem Label="📅 Fecha de Inicio" Required>
                            <DatePicker TValue="DateTime"
                                        @bind-Value="@nuevaLicencia.Desde"
                                        DefaultValue="DateTime.Today"
                                        DisabledDate="@(date => date < DateTime.Today)"
                                        Placeholder="@("Seleccione fecha de inicio")"
                                        Size="InputSize.Large" />
                        </FormItem>

                        <FormItem Label="📅 Fecha de Finalización" Required>
                            <DatePicker TValue="DateTime"
                                        @bind-Value="@nuevaLicencia.Hasta"
                                        DefaultValue="@(DateTime.Today.AddDays(1))"
                                        DisabledDate="@(date => date < nuevaLicencia.Desde)"
                                        Placeholder="@("Seleccione fecha de fin")"
                                        Size="InputSize.Large" />
                        </FormItem>
                    </div>

                    <FormItem Label="⏱️ Duración">
                        <Input Value="@($"{nuevaLicencia.DuracionEnDias} días")"
                               ReadOnly
                               Size="InputSize.Large" />
                    </FormItem>
                </div>
            </Form>
        </div>
    </div>
</Modal>

@* Modal de detalle - Rediseñado responsivo *@
<Modal @bind-Visible="_modalDetalleVisible"
       Title="@($"📋 Detalle de Licencia - {licenciaSeleccionada?.ApellidoYNombre}")"
       Footer="null"
       Width="@("90%")"
       Style="max-width: 1000px;">
    @if (licenciaSeleccionada != null)
    {
        <div class="licencias-abm">
            <div class="modal-content">
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">👤 Bombero</div>
                        <div class="detail-value">@licenciaSeleccionada.ApellidoYNombre</div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">📋 Legajo</div>
                        <div class="detail-value">@licenciaSeleccionada.NumeroLegajo</div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">🏷️ Tipo</div>
                        <div class="detail-value">@licenciaSeleccionada.TipoLicencia?.GetDisplayName()</div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">📊 Estado</div>
                        <div class="detail-value">
                            @{
                                string statusClass = licenciaSeleccionada.EstadoLicencia switch
                                {
                                    TipoEstadoLicencia.Rechazada => "status-rejected",
                                    TipoEstadoLicencia.Aprobada => "status-approved",
                                    _ => "status-pending"
                                };
                            }
                            <span class="status-badge @statusClass">
                                @licenciaSeleccionada.EstadoLicencia.ToString()
                            </span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">📅 Inicio</div>
                        <div class="detail-value">@licenciaSeleccionada.Desde.ToString("dddd, dd MMMM yyyy")</div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">📅 Fin</div>
                        <div class="detail-value">@licenciaSeleccionada.Hasta.ToString("dddd, dd MMMM yyyy")</div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">⏱️ Duración</div>
                        <div class="detail-value">
                            <Tag Color="TagColor.Processing" Style="font-size: 1rem; padding: 4px 12px;">
                                @licenciaSeleccionada.DuracionEnDias días
                            </Tag>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label">📊 Estado Temporal</div>
                        <div class="detail-value">
                            @{
                                var hoy = DateTime.Today;
                                var diasRestantes = (licenciaSeleccionada.Hasta - hoy).Days;
                                var estaVigente = hoy >= licenciaSeleccionada.Desde && hoy <= licenciaSeleccionada.Hasta;

                                string mensaje;
                                string colorTag;
                                if (estaVigente)
                                {
                                    mensaje = diasRestantes > 0 ? $"⏰ {diasRestantes} días restantes" : "⚡ Último día";
                                    colorTag = "processing";
                                }
                                else if (hoy < licenciaSeleccionada.Desde)
                                {
                                    var diasParaInicio = (licenciaSeleccionada.Desde - hoy).Days;
                                    mensaje = $"🔜 Inicia en {diasParaInicio} días";
                                    colorTag = "default";
                                }
                                else
                                {
                                    var diasTranscurridos = Math.Abs(diasRestantes);
                                    mensaje = $"✅ Finalizó hace {diasTranscurridos} días";
                                    colorTag = "success";
                                }
                            }
                            <Tag Color="@colorTag" Style="font-size: 1rem; padding: 4px 12px;">
                                @mensaje
                            </Tag>
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(licenciaSeleccionada.Descripcion))
                    {
                        <div class="detail-item detail-description">
                            <div class="detail-label">📝 Descripción</div>
                            <div class="detail-value">@licenciaSeleccionada.Descripcion</div>
                        </div>
                    }
                </div>

                <div style="display: flex; justify-content: center; margin-top: 24px;">
                    <Button Type="ButtonType.Primary"
                            Size="ButtonSize.Large"
                            OnClick="@(() => _modalDetalleVisible = false)">
                        Cerrar
                    </Button>
                </div>
            </div>
        </div>
    }
</Modal>

@code {
    // Variables para la búsqueda de licencias
    DateTime FechaBuscarI;
    DateTime FechaBuscarF;
    string? Busqueda;
    bool _loading = false;

    // Contador de licencias pendientes de aprobación
    int LicenciasVM_PendientesDeAprobacion => LicenciasVM?.Count(l => l.EstadoLicencia == TipoEstadoLicencia.Pendiente) ?? 0;

    // Lista de licencias
    List<LicenciaViewModel> LicenciasVM = new();
    List<LicenciaViewModel> LicenciasVM_SinFiltro = new();

    // Lista de bomberos para el select
    List<BomberoViweModel> BomberosVM = new();

    // Variables para modales
    private bool _modalAñadirVisible = false;
    private bool _modalDetalleVisible = false;

    private LicenciaViewModel nuevaLicencia = new LicenciaViewModel();
    private LicenciaViewModel? licenciaSeleccionada;

    // Función para manejar el clic en una fila de la tabla
    private Dictionary<string, object> OnRowClick(RowData<LicenciaViewModel> rowData)
    {
        return new Dictionary<string, object>
        {
            ["onclick"] = Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, () => MostrarDetalleLicencia(rowData.Data))
        };
    }

    // Función para mostrar el detalle de la licencia seleccionada
    private void MostrarDetalleLicencia(LicenciaViewModel licencia)
    {
        licenciaSeleccionada = licencia;
        _modalDetalleVisible = true;
    }

    // Funciones para el inicio de la página y la inicialización de datos
    protected override async Task OnInitializedAsync()
    {
        await Init();
    }

    // Función para inicializar los datos de la página
    private async Task Init()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Obtener todas las licencias y bomberos de la base de datos mediante los servicios
            var licencias = await LicenciaService.ObtenerTodasLasLicencias();
            var bomberos = await BomberoService.ObtenerTodosLosBomberosAsync();

            // Mapeo de licencias a ViewModel
            LicenciasVM_SinFiltro = LicenciasToViewModel(licencias).ToList();

            // Mapeo de bomberos a ViewModel
            BomberosVM = bomberos.ToBomberoViewModelList();

            // Filtrar las licencias según la fecha y búsqueda de texto
            LicenciasVM = FiltrarLicencias();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private List<LicenciaViewModel> FiltrarLicencias()
    {
        // Filtrar por fecha y búsqueda de texto
        var filtered = LicenciasVM_SinFiltro
            .Where(l => (FechaBuscarI == default || l.Desde >= FechaBuscarI) &&
                        (FechaBuscarF == default || l.Hasta <= FechaBuscarF) &&
                        (string.IsNullOrWhiteSpace(Busqueda) ||
                         l.ApellidoYNombre.Contains(Busqueda, StringComparison.OrdinalIgnoreCase) ||
                         l.NumeroLegajo.ToString().Contains(Busqueda) ||
                         (!string.IsNullOrEmpty(l.Descripcion) && l.Descripcion.Contains(Busqueda, StringComparison.OrdinalIgnoreCase))))
            .OrderBy(l => Math.Abs((l.Desde - DateTime.Today).TotalDays))
            .ToList();

        StateHasChanged();
        return filtered;
    }

    // Función para mapear las licencias a ViewModel
    private List<LicenciaViewModel> LicenciasToViewModel(List<Licencia> licencias)
    {
        var licenciasVM = new List<LicenciaViewModel>();

        foreach (var l in licencias)
        {
            var licVm = new LicenciaViewModel
            {
                Id = l.LicenciaId,
                TipoLicencia = l.TipoLicencia,
                NumeroLegajo = l.BomberoAfectado?.NumeroLegajo ?? 0,
                PersonaId = l.PersonalId,
                PersonalAfectado = l.BomberoAfectado?.ToBomberoViewModel(),
                ApellidoYNombre = l.BomberoAfectado != null
                    ? $"{l.BomberoAfectado.Apellido}, {l.BomberoAfectado.Nombre}"
                    : string.Empty,
                Descripcion = l.Descripcion,
                Desde = l.Desde,
                Hasta = l.Hasta,
                EstadoLicencia = l.EstadoLicencia
            };

            licenciasVM.Add(licVm);
        }

        return licenciasVM;
    }

    // Función para que se actualicen atributos de la licencia cuando se cambia el bombero seleccionado
    private async Task OnBomberoChanged(int nuevoValor)
    {
        nuevaLicencia.PersonaId = nuevoValor;

        var bombero = BomberosVM.FirstOrDefault(b => b.Id == nuevoValor);

        if (bombero != null)
        {
            nuevaLicencia.ApellidoYNombre = bombero.NombreYApellido;
            nuevaLicencia.NumeroLegajo = bombero.NumeroLegajo;
        }
        else
        {
            nuevaLicencia.ApellidoYNombre = null;
            nuevaLicencia.NumeroLegajo = 0;
        }

        StateHasChanged();
    }

    // Función para añadir una nueva licencia
    private async Task AddLicencia()
    {
        // El modal se cierra cuando se hace clic en "Cargar" asi que lo volvemos a abrir
        _modalAñadirVisible = true;

        // Validaciones mejoradas
        if (string.IsNullOrWhiteSpace(nuevaLicencia.ApellidoYNombre) ||
           nuevaLicencia.NumeroLegajo <= 0 ||
           nuevaLicencia.TipoLicencia == null ||
           nuevaLicencia.Desde == default ||
           nuevaLicencia.Hasta == default)
        {
            await MessageService.ErrorAsync("⚠️ Por favor, complete todos los campos obligatorios.");
            return;
        }

        if (!BomberosVM.Any(b => b.Id == nuevaLicencia.PersonaId))
        {
            await MessageService.ErrorAsync("❌ El bombero seleccionado no es válido.");
            return;
        }

        if (nuevaLicencia.Desde > nuevaLicencia.Hasta)
        {
            await MessageService.ErrorAsync("⚠️ La fecha de inicio no puede ser mayor que la fecha de finalización.");
            return;
        }

        if (nuevaLicencia.Desde < DateTime.Today)
        {
            await MessageService.ErrorAsync("⚠️ La fecha de inicio no puede ser anterior a hoy.");
            return;
        }

        var bombero = await BomberoService.ObtenerBomberoPorIdAsync(nuevaLicencia.PersonaId);

        if (bombero == null)
        {
            await MessageService.ErrorAsync("❌ No se encontró el bombero seleccionado.");
            return;
        }

        // Validar duración en días
        var duracionCalculada = (nuevaLicencia.Hasta - nuevaLicencia.Desde).Days + 1;

        if (nuevaLicencia.DuracionEnDias != duracionCalculada)
        {
            await MessageService.ErrorAsync("⚠️ La duración en días no coincide con las fechas seleccionadas.");
            return;
        }

        try
        {
            var nuevaLicenciaModel = new Licencia
            {
                TipoLicencia = nuevaLicencia.TipoLicencia!.Value,
                PersonalId = nuevaLicencia.PersonaId,
                Descripcion = nuevaLicencia.Descripcion,
                Desde = nuevaLicencia.Desde,
                Hasta = nuevaLicencia.Hasta,
                EstadoLicencia = TipoEstadoLicencia.Pendiente,
                BomberoAfectado = bombero,
            };

            // Guardar en la base de datos
            await LicenciaService.AgregarLicencia(nuevaLicenciaModel);

            // Cerrar modal y limpiar formulario
            _modalAñadirVisible = false;
            nuevaLicencia = new LicenciaViewModel();

            await MessageService.SuccessAsync("✅ Licencia creada exitosamente y enviada para aprobación.");
            await Init();
        }
        catch (Exception ex)
        {
            await MessageService.ErrorAsync($"❌ Error al crear la licencia: {ex.Message}");
        }
    }
}