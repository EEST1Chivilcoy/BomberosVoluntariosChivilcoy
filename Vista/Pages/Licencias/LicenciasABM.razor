@using AntDesign.TableModels
@using Vista.Data.Models.Personas.Personal
@using Vista.Data.Models.Personas.Personal.Componentes
@using Vista.Data.Mappers;

@*Servicios utilizados*@

@using Vista.Services;
@inject ILicenciaService LicenciaService
@inject IMessageService MessageService
@inject IBomberoService BomberoService

@page "/licencias"

<link rel="stylesheet" href="css/Licencias.css" />

<style>
    .template {
        width: 100%;
        height: 100%;
        max-width: 97%;
        min-width: 400px;
        max-height: 100vh;
        border-radius: 10px;
        box-shadow: rgba(99, 99, 99, 0.2) 0px 2px 8px 0px;
        background: #fff;
        display: flex;
        flex-direction: column;
        margin: 1em;
        padding: 10px;
        overflow: auto;
    }

    .ant-table {
        width: 100%;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
    }

    .ant-table-title {
        background-color: #A63333;
        padding: 16px !important;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    .ant-table-thead .ant-table-cell {
        background-color: #A63333 !important;
        color: white !important;
        font-weight: bold;
    }

    .ant-table-cell {
        padding: 16px !important;
    }

    .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
        margin-bottom: 16px;
    }

    .date-filter-container {
        display: flex;
        gap: 8px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-label {
        font-weight: 500;
        color: white;
        margin-bottom: 4px;
    }

    .actions-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
    }

    .search-container {
        flex-grow: 1;
        max-width: 300px;
    }

    .add-button {
        background-color: #4CAF50 !important;
        border-color: #438E46 !important;
        color: white !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 40px;
        padding: 0 20px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .notification-badge {
        margin-left: 16px;
        cursor: pointer;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 16px;
        font-weight: 500;
        text-align: center;
        display: inline-block;
        min-width: 100px;
    }

    .status-approved {
        background-color: #E6F7E9;
        color: #2E7D32;
    }

    .status-pending {
        background-color: #FFF8E1;
        color: #F57F17;
    }

    .status-rejected {
        background-color: #FFEBEE;
        color: #C62828;
    }

    .duration-badge {
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: 500;
        text-align: center;
        display: inline-block;
        min-width: 80px;
    }

    .modal-footer {
        margin-top: 24px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .cancel-button {
        background-color: #f5f5f5;
        border: 1px solid #d9d9d9;
    }

    /* Color de fondo para filas según estado */
    .ant-table-tbody > tr.ant-table-row.Aprobada > td {
        background-color: rgba(46, 125, 50, 0.05) !important;
    }

    .ant-table-tbody > tr.ant-table-row.Pendiente > td {
        background-color: rgba(245, 127, 23, 0.05) !important;
    }

    .ant-table-tbody > tr.ant-table-row.Rechazada > td {
        background-color: rgba(198, 40, 40, 0.05) !important;
    }

    /* Estilo para filas clickeables */
    .ant-table-tbody > tr.ant-table-row:hover {
        background-color: rgba(166, 51, 51, 0.1) !important;
        cursor: pointer;
    }

    /* Estilos para el modal de detalle */
    .detalle-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .detalle-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .detalle-label {
        font-weight: 600;
        color: #A63333;
        font-size: 14px;
        text-transform: uppercase;
    }

    .detalle-value {
        font-size: 16px;
        color: #333;
        padding: 8px 12px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }

    .detalle-descripcion {
        grid-column: 1 / -1;
    }

        .detalle-descripcion .detalle-value {
            min-height: 80px;
        }

    /* Responsive */
    @@media (max-width: 768px) {
        .filters-container {
            flex-direction: column;
            align-items: stretch;
        }

        .date-filter-container {
            flex-direction: column;
            align-items: stretch;
        }

        .actions-container {
            flex-direction: column;
            align-items: stretch;
        }

        .search-container {
            max-width: 100%;
            margin-bottom: 12px;
        }

        .add-button {
            width: 100%;
            justify-content: center;
        }

        .notification-badge {
            margin-left: 0;
            align-self: flex-end;
        }

        .detalle-container {
            grid-template-columns: 1fr;
        }
    }

    .Licencia-titulo h2 {
        font-family: 'Bebas Neue', 'Fjalla One', sans-serif;
        font-size: 2.5rem;
        letter-spacing: 2px;
        color: #ffffff;
        position: relative;
        margin-right: 950px;
        padding-bottom: 6px;
    }
</style>

<div class="template">
    <Table DataSource="LicenciasVM"
           PageSize="5"
           Responsive
           TItem="LicenciaViewModel"
           RowClassName="@(c => c.Data.EstadoLicencia.ToString())"
           OnRow="@OnRowClick">

        <TitleTemplate>
            <div style="background-color: #A63333; color: white; padding: 16px; border-radius: 8px;">
                <div class="Licencia-titulo">
                    <h2 style="margin-bottom: 0;"><Icon Type="key" style="color: #FFD700;" />LICENCIAS</h2>
                </div>
                <div class="filters-container">
                    <div class="date-filter-container">
                        <div class="filter-group">
                            <label class="filter-label">Desde:</label>
                            <DatePicker TValue="DateTime"
                                        DefaultValue="@DateTime.Now.AddDays(-7)"
                                        @bind-Value="@FechaBuscarI"
                                        Size="InputSize.Large"
                                        Style="min-width: 150px;" />
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Hasta:</label>
                            <DatePicker TValue="DateTime"
                                        DefaultValue="@DateTime.Now.AddDays(7)"
                                        @bind-Value="@FechaBuscarF"
                                        Size="InputSize.Large"
                                        Style="min-width: 150px;" />
                        </div>
                    </div>

                    <div class="actions-container">
                        <div class="search-container">
                            <Search Placeholder="Buscar licencias..."
                                    AllowClear
                                    EnterButton="true"
                                    Size="InputSize.Large"
                                    OnSearch="@(() => LicenciasVM = FiltrarLicencias())"
                                    @bind-Value="Busqueda" />
                        </div>

                        <div style="display: flex; align-items: center;">
                            <Button Class="add-button"
                                    OnClick="@(() => _modalAñadirVisible = true)"
                                    Icon="plus">
                                Nueva Licencia
                            </Button>

                            <Dropdown Trigger="@(new Trigger[] { Trigger.Click })"
                                      Placement="Placement.BottomRight"
                                      Arrow
                                      Class="notification-badge">
                                <Overlay>
                                    <Menu Style="min-width:520px; max-width:1000px;">
                                        <LicenciasAprobar OnCompleted="@Init" />
                                    </Menu>
                                </Overlay>
                                <ChildContent>
                                    <Badge Count="LicenciasVM_PendientesDeAprobacion" Style="font-size: 14px;">
                                        <Button Shape="ButtonShape.Circle" Icon="bell" Size="ButtonSize.Large" />
                                    </Badge>
                                </ChildContent>
                            </Dropdown>
                        </div>
                    </div>
                </div>
            </div>
        </TitleTemplate>

        <ColumnDefinitions Context="licencia">
            <PropertyColumn Title="Apellido y Nombre"
                            Property="c => c.ApellidoYNombre"
                            Sortable
                            Width="250px" />

            <PropertyColumn Title="Desde"
                            Property="c => c.Desde"
                            Format="dd/MM/yyyy"
                            Sortable
                            DefaultSortOrder="SortDirection.Descending"
                            Width="130px" />

            <PropertyColumn Title="Hasta"
                            Property="c => c.Hasta"
                            Format="dd/MM/yyyy"
                            Sortable
                            Width="130px" />

            <PropertyColumn Title="Duración"
                            Property="c => c.DuracionEnDias"
                            Sortable
                            Width="120px">
                <Template>
                    @{
                        string bgColor;
                        string textColor;

                        if (licencia.EstadoLicencia == TipoEstadoLicencia.Rechazada)
                        {
                            bgColor = "#FFEBEE";
                            textColor = "#C62828";
                        }
                        else if (licencia.EstadoLicencia == TipoEstadoLicencia.Aprobada)
                        {
                            bgColor = "#E6F7E9";
                            textColor = "#2E7D32";
                        }
                        else
                        {
                            bgColor = "#FFF8E1";
                            textColor = "#F57F17";
                        }
                    }
                    <span class="duration-badge" style="background-color:@bgColor; color:@textColor;">
                        @licencia.DuracionEnDias días
                    </span>
                </Template>
            </PropertyColumn>

            <PropertyColumn Title="Tipo"
                            Property="@(c => c.TipoLicencia.GetDisplayName())"
                            Sortable="true"
                            Width="200px" />

            <PropertyColumn Title="Estado"
                            Property="c => c.EstadoLicencia"
                            Sortable
                            Filterable
                            Width="150px">
                <Template>
                    @{
                        string statusClass = licencia.EstadoLicencia switch
                        {
                            TipoEstadoLicencia.Rechazada => "status-rejected",
                            TipoEstadoLicencia.Aprobada => "status-approved",
                            _ => "status-pending"
                        };
                    }
                    <span class="status-badge @statusClass">
                        @licencia.EstadoLicencia.ToString()
                    </span>
                </Template>
            </PropertyColumn>
        </ColumnDefinitions>
    </Table>
</div>

@*Modal para el añadir Licencia*@
<Modal @bind-Visible="_modalAñadirVisible" Title="Añadir Licencia" OkText="@("Cargar")" CancelText="@("Cancelar")" OnOk="@AddLicencia">
    <Form Model="nuevaLicencia">
        <FormItem Label="Nombre del Bombero">
            <Select TItem="BomberoViweModel"
                    TItemValue="int"
                    DataSource="@BomberosVM"
                    Value="nuevaLicencia.PersonaId"
                    ValueChanged="OnBomberoChanged"
                    ValueExpression="() => nuevaLicencia.PersonaId"
                    LabelName="@nameof(BomberoViweModel.NombreYApellido)"
                    ValueName="@nameof(BomberoViweModel.Id)"
                    Placeholder="Seleccione el bombero"
                    DefaultActiveFirstOption="false"
                    AllowClear="true"
                    EnableSearch>
            </Select>
        </FormItem>

        <FormItem Label="Numero Legajo">
            <AntDesign.InputNumber @bind-Value="nuevaLicencia.NumeroLegajo" Disabled />
        </FormItem>

        <FormItem Label="Tipo Licencia">
            <EnumSelect TEnum="TipoLicencia?"
                        @bind-Value="@nuevaLicencia.TipoLicencia"
                        AllowClear
                        Placeholder="Seleccione el tipo de licencia" />
        </FormItem>

        @if (nuevaLicencia.TipoLicencia == TipoLicencia.RazonesDeSalud)
        {
            <FormItem Label="Adjuntar Certificado Médico">
                <InputFile />
            </FormItem>
        }

        <FormItem Label="Descripcion">
            <TextArea @bind-Value="@nuevaLicencia.Descripcion"
                      Placeholder="Ingrese una descripción"
                      Rows="4" />
        </FormItem>

        <FormItem Label="Fecha inicio">
            <DatePicker TValue="DateTime"
                        DefaultValue="DateTime.Now"
                        @bind-Value="@nuevaLicencia.Desde"
                        DisabledDate="@(date => date < DateTime.Today)"
                        Placeholder="@("Seleccione la fecha de inicio")" />
        </FormItem>

        <FormItem Label="Fecha finalizacion">
            <DatePicker TValue="DateTime"
                        DefaultValue="DateTime.Now"
                        @bind-Value="@nuevaLicencia.Hasta"
                        DisabledDate="@(date => date < nuevaLicencia.Desde)"
                        Placeholder="@("Seleccione la fecha de finalización")" />
        </FormItem>

        <FormItem Label="Duración en días">
            <Input Value="@nuevaLicencia.DuracionEnDias.ToString()" ReadOnly />
        </FormItem>
    </Form>

</Modal>

@*Modal para el Detalle de la Licencia*@
<Modal @bind-Visible="_modalDetalleVisible"
       Title="@($"Detalle de Licencia - {licenciaSeleccionada?.ApellidoYNombre}")"
       Footer="null"
       Width="800">
    @if (licenciaSeleccionada != null)
    {
        <div class="detalle-container">
            <div class="detalle-item">
                <div class="detalle-label">Bombero</div>
                <div class="detalle-value">@licenciaSeleccionada.ApellidoYNombre</div>
            </div>

            <div class="detalle-item">
                <div class="detalle-label">Número de Legajo</div>
                <div class="detalle-value">@licenciaSeleccionada.NumeroLegajo</div>
            </div>

            <div class="detalle-item">
                <div class="detalle-label">Tipo de Licencia</div>
                <div class="detalle-value">@licenciaSeleccionada.TipoLicencia?.GetDisplayName()</div>
            </div>

            <div class="detalle-item">
                <div class="detalle-label">Estado</div>
                <div class="detalle-value">
                    @{
                        string statusClass = licenciaSeleccionada.EstadoLicencia switch
                        {
                            TipoEstadoLicencia.Rechazada => "status-rejected",
                            TipoEstadoLicencia.Aprobada => "status-approved",
                            _ => "status-pending"
                        };
                    }
                    <span class="status-badge @statusClass">
                        @licenciaSeleccionada.EstadoLicencia.ToString()
                    </span>
                </div>
            </div>

            <div class="detalle-item">
                <div class="detalle-label">Fecha de Inicio</div>
                <div class="detalle-value">@licenciaSeleccionada.Desde.ToString("dd/MM/yyyy")</div>
            </div>

            <div class="detalle-item">
                <div class="detalle-label">Fecha de Finalización</div>
                <div class="detalle-value">@licenciaSeleccionada.Hasta.ToString("dd/MM/yyyy")</div>
            </div>

            <div class="detalle-item">
                <div class="detalle-label">Duración</div>
                <div class="detalle-value">@licenciaSeleccionada.DuracionEnDias días</div>
            </div>

            <div class="detalle-item">
                <div class="detalle-label">Días Restantes/Transcurridos</div>
                <div class="detalle-value">
                    @{
                        var hoy = DateTime.Today;
                        var diasRestantes = (licenciaSeleccionada.Hasta - hoy).Days;
                        var estaVigente = hoy >= licenciaSeleccionada.Desde && hoy <= licenciaSeleccionada.Hasta;

                        string mensaje;
                        if (estaVigente)
                        {
                            mensaje = diasRestantes > 0 ? $"{diasRestantes} días restantes" : "Último día";
                        }
                        else if (hoy < licenciaSeleccionada.Desde)
                        {
                            var diasParaInicio = (licenciaSeleccionada.Desde - hoy).Days;
                            mensaje = $"Inicia en {diasParaInicio} días";
                        }
                        else
                        {
                            var diasTranscurridos = Math.Abs(diasRestantes);
                            mensaje = $"Finalizó hace {diasTranscurridos} días";
                        }
                    }
                    @mensaje
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(licenciaSeleccionada.Descripcion))
            {
                <div class="detalle-item detalle-descripcion">
                    <div class="detalle-label">Descripción</div>
                    <div class="detalle-value">@licenciaSeleccionada.Descripcion</div>
                </div>
            }
        </div>

        <div class="modal-footer">
            <Button OnClick="@(() => _modalDetalleVisible = false)">
                Cerrar
            </Button>
        </div>
    }
</Modal>

@*Modal para el Historial de la Licencia*@

@code {
    // Variables para la búsqueda de licencias
    DateTime FechaBuscarI;
    DateTime FechaBuscarF;
    string? Busqueda;

    // Contador de licencias pendientes de aprobación
    int LicenciasVM_PendientesDeAprobacion => LicenciasVM.Count(l => l.EstadoLicencia == TipoEstadoLicencia.Pendiente);

    // Lista de licencias
    List<LicenciaViewModel> LicenciasVM = new();
    List<LicenciaViewModel> LicenciasVM_SinFiltro = new();

    // Lista de bomberos para el select
    List<BomberoViweModel> BomberosVM = new();

    // Variables para el modal de añadir licencia
    private bool _modalAñadirVisible = false;
    private bool _modalDetalleVisible = false;

    private LicenciaViewModel nuevaLicencia = new LicenciaViewModel();
    private LicenciaViewModel? licenciaSeleccionada;

    // Función para manejar el clic en una fila de la tabla
    private Dictionary<string, object> OnRowClick(RowData<LicenciaViewModel> rowData)
    {
        return new Dictionary<string, object>
        {
            ["onclick"] = Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, () => MostrarDetalleLicencia(rowData.Data))
        };
    }

    // Función para mostrar el detalle de la licencia seleccionada
    private void MostrarDetalleLicencia(LicenciaViewModel licencia)
    {
        licenciaSeleccionada = licencia;
        _modalDetalleVisible = true;
    }

    // Funciones para el inicio de la página y la inicialización de datos
    protected override async Task OnInitializedAsync()
    {
        await Init();
    }

    // Función para inicializar los datos de la página
    private async Task Init()
    {
        // Obtener todas las licencias y bomberos de la base de datos mediante los servicios
        var licencias = await LicenciaService.ObtenerTodasLasLicencias();
        var bomberos = await BomberoService.ObtenerTodosLosBomberosAsync();

        // Mapeo de licencias a ViewModel
        LicenciasVM_SinFiltro = LicenciasToViewModel(licencias).ToList();

        // Mapeo de bomberos a ViewModel
        BomberosVM = bomberos.ToBomberoViewModelList();

        // Filtrar las licencias según la fecha y búsqueda de texto
        LicenciasVM = FiltrarLicencias();
    }

    private List<LicenciaViewModel> FiltrarLicencias()
    {
        // Filtrar por fecha y búsqueda de texto
        return LicenciasVM_SinFiltro
            .Where(l => (FechaBuscarI == default || l.Desde >= FechaBuscarI) &&
                        (FechaBuscarF == default || l.Hasta <= FechaBuscarF) &&
                        (string.IsNullOrWhiteSpace(Busqueda) ||
                         l.ApellidoYNombre.Contains(Busqueda, StringComparison.OrdinalIgnoreCase)))
            .OrderBy(l => Math.Abs((l.Desde - DateTime.Today).TotalDays))
            .ToList();

        StateHasChanged();
    }

    // Función para mapear las licencias a ViewModel
    private List<LicenciaViewModel> LicenciasToViewModel(List<Licencia> licencias)
    {
        var licenciasVM = new List<LicenciaViewModel>();

        foreach (var l in licencias)
        {
            var licVm = new LicenciaViewModel
            {
                Id = l.LicenciaId,
                TipoLicencia = l.TipoLicencia,
                NumeroLegajo = l.BomberoAfectado?.NumeroLegajo ?? 0,
                PersonaId = l.PersonalId,
                PersonalAfectado = l.BomberoAfectado.ToBomberoViewModel(),
                ApellidoYNombre = l.BomberoAfectado != null
                    ? $"{l.BomberoAfectado.Apellido}, {l.BomberoAfectado.Nombre}"
                    : string.Empty,
                Descripcion = l.Descripcion,
                Desde = l.Desde,
                Hasta = l.Hasta,
                EstadoLicencia = l.EstadoLicencia
            };

            licenciasVM.Add(licVm);
        }

        return licenciasVM;
    }

    // Función para que se actualicen atributos de la licencia cuando se cambia el bombero seleccionado
    private async Task OnBomberoChanged(int nuevoValor)
    {
        nuevaLicencia.PersonaId = nuevoValor;

        var bombero = BomberosVM.FirstOrDefault(b => b.Id == nuevoValor);

        if (bombero != null)
        {
            nuevaLicencia.ApellidoYNombre = bombero.NombreYApellido;
            nuevaLicencia.NumeroLegajo = bombero.NumeroLegajo;
        }
        else
        {
            nuevaLicencia.ApellidoYNombre = null;
            nuevaLicencia.NumeroLegajo = 0;
        }

        StateHasChanged();
    }

    // Función para añadir una nueva licencia
    private async Task AddLicencia()
    {
        // El modal se cierra cuando se hace clic en "Cargar" asi que lo volvemos a abrir
        _modalAñadirVisible = true;

        // Validaciones
        if (string.IsNullOrWhiteSpace(nuevaLicencia.ApellidoYNombre) ||
           nuevaLicencia.NumeroLegajo <= 0 ||
           nuevaLicencia.TipoLicencia == null ||
           nuevaLicencia.Desde == default ||
           nuevaLicencia.Hasta == default)
        {
            await MessageService.ErrorAsync("Por favor, complete todos los campos obligatorios.");
            return;
        }

        if (!BomberosVM.Any(b => b.Id == nuevaLicencia.PersonaId))
        {
            await MessageService.ErrorAsync("El bombero seleccionado no es válido.");
            return;
        }

        if (nuevaLicencia.Desde > nuevaLicencia.Hasta)
        {
            await MessageService.ErrorAsync("La fecha de inicio no puede ser mayor que la fecha de finalización.");
            return;
        }

        if (nuevaLicencia.Desde < DateTime.Today)
        {
            await MessageService.ErrorAsync("La fecha de inicio no puede ser anterior a hoy.");
            return;
        }

        @*if (nuevaLicencia.TipoLicencia == TipoLicencia.RazonesDeSalud && (archivoCertificado == null || archivoCertificado.Length == 0))
        {
            await MessageService.ErrorAsync("Debe adjuntar el certificado médico para licencias por razones de salud.");
            return;
        } <-- Arreglar en algun momento el tema del certificado medico*@

        var bombero = await BomberoService.ObtenerBomberoPorIdAsync(nuevaLicencia.PersonaId);

        if (bombero == null)
        {
            await MessageService.ErrorAsync("No se encontró el bombero seleccionado.");
            return;
        }

        // Validar duración en días
        var duracionCalculada = (nuevaLicencia.Hasta - nuevaLicencia.Desde).Days + 1;

        if (nuevaLicencia.DuracionEnDias != duracionCalculada)
        {
            await MessageService.ErrorAsync("La duración en días no coincide con las fechas seleccionadas.");
            return;
        }

        var nuevaLicenciaModel = new Licencia
        {
            TipoLicencia = nuevaLicencia.TipoLicencia!.Value,
            PersonalId = nuevaLicencia.PersonaId,
            Descripcion = nuevaLicencia.Descripcion,
            Desde = nuevaLicencia.Desde,
            Hasta = nuevaLicencia.Hasta,
            EstadoLicencia = TipoEstadoLicencia.Pendiente,
            BomberoAfectado = bombero,
        };

        // Si todo es válido, guardar la nueva licencia en la base de datos mediante el servicio
        await LicenciaService.AgregarLicencia(nuevaLicenciaModel);

        // Cerrar el modal y limpiar el formulario
        _modalAñadirVisible = false;
        nuevaLicencia = new LicenciaViewModel();

        // Recargamos la pagina para mostrar la nueva licencia
        await Init();
    }
}