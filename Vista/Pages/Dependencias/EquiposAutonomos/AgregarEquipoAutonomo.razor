@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations

@inject IDbContextFactory<BomberosDbContext> DbFactory
@inject IMessageService message

<style>
    .modal-crear-equipo .ant-modal-content {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border: 2px solid #732D2D;
        margin-top: -50px;
        margin-bottom: 0px;
    }

    .modal-crear-equipo .ant-modal-title {
        color: white !important;
    }

    .modal-crear-equipo .ant-modal-header {
        background-color: #A63333;
        padding: 16px 24px;
    }

    .modal-crear-equipo-content {
        padding: 24px;
    }

    .modal-crear-equipo-form-item {
        margin-bottom: 24px;
        position: relative;
        padding-left: 10px;
    }

        .modal-crear-equipo-form-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            border-radius: 5px;
        }

        .modal-crear-equipo-form-item .ant-form-item-label > label,
        .modal-crear-equipo-form-full-width .ant-form-item-label > label {
            font-weight: 700;
            color: #434343;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            transition: color 0.3s ease;
            margin-bottom: 8px;
            min-height: 24px;
        }

            .modal-crear-equipo-form-item .ant-form-item-label > label:hover,
            .modal-crear-equipo-form-full-width .ant-form-item-label > label:hover {
                color: #A63333;
            }

    .modal-crear-equipo .ant-input,
    .modal-crear-equipo .ant-select-selector,
    .modal-crear-equipo .ant-picker,
    .modal-crear-equipo .ant-input-number {
        height: 44px !important;
        border-radius: 8px !important;
        border: 2px solid #d9d9d9 !important;
        background: #fff !important;
        color: #434343 !important;
        font-size: 15px !important;
        transition: all 0.3s ease !important;
    }

    .modal-crear-equipo .ant-input:focus,
    .modal-crear-equipo .ant-input:hover,
    .modal-crear-equipo .ant-select-selector:focus,
    .modal-crear-equipo .ant-select-selector:hover,
    .modal-crear-equipo .ant-picker:focus,
    .modal-crear-equipo .ant-picker:hover,
    .modal-crear-equipo .ant-picker-input > input:focus,
    .modal-crear-equipo .ant-picker-input > input:hover,
    .modal-crear-equipo .ant-input-number-input:focus,
    .modal-crear-equipo .ant-input-number-input:hover {
        border-color: #FFD700 !important;
        box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2) !important;
    }

    .modal-crear-equipo .ant-select-selection-item {
        font-size: 15px !important;
        line-height: 40px !important;
    }

    .modal-crear-equipo .ant-picker-input > input {
        font-size: 15px !important;
    }

    .modal-crear-equipo-footer {
        display: flex;
        justify-content: flex-end;
        gap: 16px;
        margin-top: 32px;
        margin-bottom: 0px;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
    }

    .modal-crear-equipo .ant-btn {
        height: 44px !important;
        border-radius: 8px !important;
        font-size: 15px !important;
        font-weight: 600 !important;
        padding: 0 24px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .modal-crear-equipo .ant-btn-primary {
        background: linear-gradient(135deg, #4CAF50 0%, #438E46 100%) !important;
        border: none !important;
        color: #fff !important;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.18);
    }

        .modal-crear-equipo .ant-btn-primary:hover {
            background: linear-gradient(135deg, #388E3C 0%, #4CAF50 100%) !important;
            color: #fff !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.25);
        }

    .modal-crear-equipo .ant-btn-default {
        border: 2px solid #d9d9d9 !important;
        color: #434343 !important;
        background: #fff !important;
    }

        .modal-crear-equipo .ant-btn-default:hover {
            border-color: #A63333 !important;
            color: #A63333 !important;
            background: #fff !important;
        }

    .modal-crear-equipo-prueba-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #e9ecef;
        margin-top: 8px;
    }

    .modal-crear-equipo-prueba-title {
        font-size: 16px;
        font-weight: 700;
        color: #A63333;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
</style>

<Form Loading="loading" Model="@equipoAutonomoModel"
      LabelColSpan="8"
      WrapperColSpan="16"
      OnFinish="OnFinish"
      OnFinishFailed="OnFinishFailed"
      @ref="@_form"
      Class="modal-crear-equipo"
      Layout="FormLayout.Horizontal">

    <div class="modal-crear-equipo-content">
        <Row Gutter="24">
            <AntDesign.Col Span="12">
                <FormItem Label="📋 Número de Serie" Required Class="modal-crear-equipo-form-item">
                    <Input @bind-Value="@equipoAutonomoModel.NroSerie" 
                           Placeholder="Ingrese el número de serie" />
                </FormItem>
            </AntDesign.Col>
            <AntDesign.Col Span="12">
                <FormItem Label="🔧 Número de Tubo" Class="modal-crear-equipo-form-item">
                    <Input @bind-Value="@equipoAutonomoModel.NroTubo" 
                           Placeholder="Ingrese el número de tubo" />
                </FormItem>
            </AntDesign.Col>
        </Row>
        
        <Row Gutter="24">
            <AntDesign.Col Span="12">
                <FormItem Label="🏭 Marca" Class="modal-crear-equipo-form-item">
                    <Input @bind-Value="@equipoAutonomoModel.Marca" 
                           Placeholder="Ingrese la marca" />
                </FormItem>
            </AntDesign.Col>
            <AntDesign.Col Span="12">
                <FormItem Label="📱 Modelo" Class="modal-crear-equipo-form-item">
                    <Input @bind-Value="@equipoAutonomoModel.Modelo" 
                           Placeholder="Ingrese el modelo" />
                </FormItem>
            </AntDesign.Col>
        </Row>
        
        <Row Gutter="24">
            <AntDesign.Col Span="12">
                <FormItem Label="🧱 Tipo de Material" Class="modal-crear-equipo-form-item">
                    <Input @bind-Value="@equipoAutonomoModel.TipoMaterial" 
                           Placeholder="Ingrese el tipo de material" />
                </FormItem>
            </AntDesign.Col>
            <AntDesign.Col Span="12">
                <FormItem Label="📊 Estado del Equipo" Class="modal-crear-equipo-form-item">
                    <EnumSelect TEnum="TipoEstadoEquipoAutonomo" 
                               @bind-Value="@equipoAutonomoModel.Estado"
                               Placeholder="Seleccione el estado" />
                </FormItem>
            </AntDesign.Col>
        </Row>

        @if (equipoAutonomoModel.Estado == TipoEstadoEquipoAutonomo.PruebaHidraulica)
        {
                <Row Gutter="24">
                    <AntDesign.Col Span="12">
                        <FormItem Label="📅 Fecha de Inicio" Class="modal-crear-equipo-form-item">
                            <DatePicker @bind-Value="@equipoAutonomoModel.FechaInicioPrueba" 
                                       DefaultValue="DateTime.Today"
                                       DisabledDate="@(date => date < DateTime.Today)"
                                       Placeholder="@("Seleccione fecha de inicio")"
                                       Size="InputSize.Large" />
                        </FormItem>
                    </AntDesign.Col>
                    <AntDesign.Col Span="12">
                        <FormItem Label="📅 Fecha de Finalización" Class="modal-crear-equipo-form-item">
                            <DatePicker @bind-Value="@equipoAutonomoModel.FechaFinPrueba" 
                                       DisabledDate="@(date => date < DateTime.Today)"
                                       Placeholder="@("Seleccione fecha de finalización")"
                                       Size="InputSize.Large" />
                        </FormItem>
                    </AntDesign.Col>
                </Row>
        }

        <div class="modal-crear-equipo-footer">
            <Button Type="@ButtonType.Primary" HtmlType="submit">
                ✅ Agregar Equipo
            </Button>
            <Button Type="@ButtonType.Default" OnClick="Reset">
                🔄 Limpiar
            </Button>
        </div>
    </div>
</Form>

@code {
    [Parameter] public EventCallback OnFinishCallback { get; set; }

    public enum TipoEstadoEquipoAutonomo
    {
        Stock,
        Activo,
        Baja,
        Reparacion,
        PruebaHidraulica
    }

    private class EquipoAutonomoModel
    {
        [Required, StringLength(255)]
        public string NroSerie { get; set; } = "";
        public string? NroTubo { get; set; }
        public string? Marca { get; set; }
        public string? Modelo { get; set; }
        public string? TipoMaterial { get; set; }
        public TipoEstadoEquipoAutonomo Estado { get; set; } = TipoEstadoEquipoAutonomo.Stock;
        public DateTime? FechaInicioPrueba { get; set; }
        public DateTime? FechaFinPrueba { get; set; }
    }

    private EquipoAutonomoModel equipoAutonomoModel = new();
    private Form<EquipoAutonomoModel> _form;
    private bool loading = false;

    private async Task OnFinish(EditContext editContext)
    {
        loading = true;
        try
        {
            // TODO: Implement actual database save when models are created
            await Task.Delay(1000); // Simulate save operation
            
            await message.SuccessAsync("Equipo autónomo agregado correctamente.");
            Reset();
            await OnFinishCallback.InvokeAsync();
        }
        catch (Exception ex)
        {
            await message.ErrorAsync(ex.Message, 5);
        }
        finally
        {
            loading = false;
        }
    }

    private void OnFinishFailed(EditContext editContext)
    {
        message.Error("Error en el formulario. Verifique los datos.");
    }

    private void Reset()
    {
        equipoAutonomoModel = new();
        _form?.Reset();
    }
}

