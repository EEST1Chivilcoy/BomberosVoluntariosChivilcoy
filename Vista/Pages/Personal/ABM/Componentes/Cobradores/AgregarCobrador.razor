@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using Vista.Data.Mappers
@using System.ComponentModel
@using Vista.Data.Models.Personas.Personal
@using Vista.Data.Models.Personas.Personal.Componentes
@using Vista.Data.Models.Imagenes
@using Vista.Data.ViewModels.Personal
@using Vista.Data.Enums.Personal.ComisionDirectiva
@using Vista.Data.Enums.Personal.Cobrador
@using Vista.Data.Enums.Socios
@using Microsoft.Identity.Web
@using Microsoft.Graph
@using AntDesign

@attribute [Authorize]
@page "/fire-force/personal/cobrador/agregar"

@*Servicios Utilizados*@
@using Vista.Services
@inject NavigationManager navigationManager
@inject MicrosoftIdentityConsentAndConditionalAccessHandler ConsentHandler
@inject IMessageService message
@inject ICobradorService CobradorService
@inject IEntraIDService EntraIDService

<style>
	/* Estilos generales */
	.container {
		padding: 24px !important;
		min-height: 100vh !important;
	}

	.page-title {
		font-size: 24px !important;
		font-weight: 600 !important;
		color: #1f1f1f !important;
		margin-bottom: 24px !important;
		display: flex !important;
		align-items: center !important;
	}

	.page-title-icon {
		margin-right: 12px !important;
		color: #c43a3a !important;
	}

	.card {
		background-color: white !important;
		border-radius: 8px !important;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
		padding: 24px !important;
		margin-bottom: 24px !important;
	}

	.card-title {
		font-size: 18px !important;
		font-weight: 500 !important;
		color: #434343 !important;
		margin-bottom: 16px !important;
		padding-bottom: 12px !important;
		border-bottom: 1px solid #f0f0f0 !important;
	}

	/* Estilos de la foto */
	.profile-photo-container {
		display: flex !important;
		flex-direction: column !important;
		align-items: center !important;
		padding: 16px !important;
	}

	.photo-preview {
		width: 150px !important;
		height: 150px !important;
		border-radius: 50% !important;
		overflow: hidden !important;
		margin-bottom: 16px !important;
		display: flex !important;
		align-items: center !important;
		justify-content: center !important;
	}

	.upload-actions {
		display: flex !important;
		gap: 8px !important;
	}

	/* Estilo para las secciones del formulario */
	.form-section {
		margin-bottom: 24px !important;
	}

	/* Estilo para los botones de acción */
	.action-buttons {
		display: flex !important;
		justify-content: flex-end !important;
		gap: 12px !important;
		margin-top: 24px !important;
	}

	/* Estilo para los campos */
	.ant-form-item {
		margin-bottom: 16px !important;
	}

	.ant-form-item-label > label {
		color: #595959 !important;
		font-weight: 500 !important;
	}

	.ant-input,
	.ant-select:not(.ant-select-customize-input) .ant-select-selector,
	.ant-picker,
	.ant-input-number {
		border-radius: 4px !important;
		border: 1px solid #d9d9d9 !important;
	}

		.ant-input:hover,
		.ant-select:not(.ant-select-customize-input) .ant-select-selector:hover,
		.ant-picker:hover,
		.ant-input-number:hover {
			border-color: #c43a3a !important;
		}

		.ant-input:focus,
		.ant-select-focused:not(.ant-select-customize-input) .ant-select-selector,
		.ant-picker-focused,
		.ant-input-number-focused {
			border-color: #c43a3a !important;
			box-shadow: 0 0 0 2px rgba(196, 58, 58, 0.2) !important;
		}

	/* Ajuste visual para el switch */
	.ant-switch-checked {
		background-color: #c43a3a !important;
	}

	/* Estilo para campos requeridos */
	.required-field::after {
		content: '*' !important;
		color: #c43a3a !important;
		margin-left: 4px !important;
	}

	/* Estilo para el campo condicional de chofer */
	.conditional-field {
		margin-top: 12px !important;
		padding-top: 12px !important;
		border-top: 1px dashed #f0f0f0 !important;
	}
</style>

<div class="container">
	<div class="page-title">
		<div>
			<Icon Type="fund" Theme="IconThemeType.Fill" Class="page-title-icon" />
			<span>Registro de Nuevo Cobrador</span>
		</div>
	</div>

	@if (personalView != null)
	{
		<Form Model="@personalView"
			  Layout="FormLayout.Vertical"
			  OnFinish="OnFinish"
			  Loading="isLoading">

			@*Información Personal (Común para todos)*@
			<div class="card">
				<div class="card-title">Información Personal</div>
				<AntDesign.Row Gutter="24">
					<AntDesign.Col Span="6">
						<div class="profile-photo-container">
							<div class="photo-preview">
								@if (ImageUrlPreview != null)
								{
									<Avatar Src="@ImageUrlPreview" Alt="Foto de perfil" Size="@("10rem")" />
								}
								else
								{
									<Avatar Icon="@IconType.Outline.User" Size="@("10rem")" />
								}
							</div>
							@if (ImageUrlPreview == null)
							{
								<div class="upload-actions">
									<Button Type="@ButtonType.Primary" Danger>
										<Icon Type="close" /> No se ha cargado ninguna foto
									</Button>
								</div>
							}
						</div>
					</AntDesign.Col>
					<AntDesign.Col Span="18">
						<AntDesign.Row Gutter="16">
							<AntDesign.Col Span="8">
								<FormItem Label="Nombre">
									<Input @bind-Value="@personalView.Nombre" Disabled="@EntraIDisDisponbile" />
								</FormItem>
							</AntDesign.Col>
							<AntDesign.Col Span="8">
								<FormItem Label="Apellido">
									<Input @bind-Value="@personalView.Apellido" Disabled="@EntraIDisDisponbile" />
								</FormItem>
							</AntDesign.Col>
						</AntDesign.Row>

						<AntDesign.Row Gutter="16">
							<AntDesign.Col Span="24">
								<FormItem Label="UPN">
									<AntDesign.Input @bind-Value="@personalView.UPN" Disabled="@(!EntraIDisDisponbile)">
										<AddOnAfter>
											<label>@@bomberoschivilcoy.org.ar</label>
											<AntDesign.Button Type="ButtonType.Primary"
															  Size="ButtonSize.Small"
															  Disabled="@(!EntraIDisDisponbile)"
															  OnClick="@(() => BusquedaPorUPN(personalView.UPN))">
												<Icon Type="search" />
											</AntDesign.Button>
										</AddOnAfter>
									</AntDesign.Input>
								</FormItem>
							</AntDesign.Col>
						</AntDesign.Row>

						<AntDesign.Row Gutter="16">
							<AntDesign.Col Span="8">
								<FormItem Label="DNI">
									<Input @bind-Value="@personalView.Documento" Placeholder="Ingrese el DNI" />
								</FormItem>
							</AntDesign.Col>
							<AntDesign.Col Span="8">
								<FormItem Label="Fecha de Nacimiento">
									<DatePicker @bind-Value="@personalView.FechaNacimiento"
												Picker="@DatePickerType.Date"
												Style="width: 100%;"
												Placeholder="@("Seleccione fecha")"
												AllowClear />
								</FormItem>
							</AntDesign.Col>
							<AntDesign.Col Span="8">
								<FormItem Label="Lugar de nacimiento">
									<Input @bind-Value="@personalView.LugarNacimiento" Placeholder="Ingrese lugar de nacimiento" />
								</FormItem>
							</AntDesign.Col>
						</AntDesign.Row>

						<AntDesign.Row Gutter="16">
							<AntDesign.Col Span="12">
								<FormItem Label="Dirección">
									<Input @bind-Value="@personalView.Direccion" Placeholder="Ingrese dirección" />
								</FormItem>
							</AntDesign.Col>
							<AntDesign.Col Span="6">
								<FormItem Label="Sexo">
									<EnumSelect TEnum="TipoSexo ?" @bind-Value="@personalView.Sexo" />
								</FormItem>
							</AntDesign.Col>
							<AntDesign.Col Span="6">
								<FormItem Label="Grupo Sanguíneo">
									<EnumSelect TEnum="TipoGrupoSanguineo ?" @bind-Value="@personalView.GrupoSanguineo" AllowClear />
								</FormItem>
							</AntDesign.Col>
						</AntDesign.Row>
					</AntDesign.Col>
				</AntDesign.Row>
			</div>

			@*Información Profesional*@
			<div class="card">
				<div class="card-title">Información Profesional</div>

				<AntDesign.Row Gutter="16">
					<AntDesign.Col Span="6">
						<FormItem Label="Estado">
							<EnumSelect TEnum="EstadoCobrador" @bind-Value="@personalView.Estado" AllowClear />
						</FormItem>
					</AntDesign.Col>
					<AntDesign.Col Span="6">
						<FormItem Label="Zonas asignadas">
							<EnumSelect Mode="SelectMode.Multiple" TEnum="Zona" @bind-Value="@personalView.ZonasAsignadas" AllowClear />
						</FormItem>
					</AntDesign.Col>
				</AntDesign.Row>
				<AntDesign.Row Gutter="16">
					<AntDesign.Col Span="8">
						<FormItem Label="Fecha de Aceptación">
							<DatePicker @bind-Value="@personalView.FechaAceptacion"
										Picker="@DatePickerType.Date"
										Style="width: 100%;"
										Placeholder="@("Seleccione fecha")"
										AllowClear />
						</FormItem>
					</AntDesign.Col>
				</AntDesign.Row>

			</div>

			@*Información de Contacto*@
			<div class="card">
				<div class="card-title">Información de Contacto</div>
				<AntDesign.Row Gutter="16">
					<AntDesign.Col Span="6">
						<FormItem Label="Teléfono Celular">
							<Input @bind-Value="@personalView.TelefonoCel" Placeholder="Ingrese teléfono celular" />
						</FormItem>
					</AntDesign.Col>
					<AntDesign.Col Span="6">
						<FormItem Label="Teléfono Fijo">
							<Input @bind-Value="@personalView.TelefonoFijo" Placeholder="Ingrese teléfono fijo" />
						</FormItem>
					</AntDesign.Col>
					<AntDesign.Col Span="6">
						<FormItem Label="Teléfono Laboral">
							<Input @bind-Value="@personalView.TelefonoLaboral" Placeholder="Ingrese teléfono laboral" />
						</FormItem>
					</AntDesign.Col>
					<AntDesign.Col Span="6">
						<FormItem Label="Email">
							<Input @bind-Value="@personalView.Email" Placeholder="Ingrese email" />
						</FormItem>
					</AntDesign.Col>
				</AntDesign.Row>
			</div>

			@*Botones de Acción*@
			<div class="action-buttons">
				<Button Type="@ButtonType.Default" OnClick="Cancelar">
					Cancelar
				</Button>
				<Button Type="@ButtonType.Primary" HtmlType="submit" Class="primary-button" Disabled="@(!EntraIDisDisponbile)">
					Registrar Cobrador
				</Button>
			</div>
		</Form>
	}
	else
	{
		<Result Status="ResultStatus.Error"
				Title="Error"
				SubTitle="No se ha inicializado correctamente el formulario.">
			<Extra>
				<Button Type="@ButtonType.Primary" OnClick="Cancelar">
					Volver al listado
				</Button>
			</Extra>
		</Result>
	}
</div>

@code {
	private CobradorViewModel? personalView = new();
	private ImageViewModel imageViewModel = new();
	private CancellationTokenSource? _debounceTokenSource;
	private bool EntraIDisDisponbile = false;
	private bool isLoading = true;

	private string? ImageUrlPreview => imageViewModel.Base64 != null
		? $"data:{imageViewModel.TipoImagen};base64,{imageViewModel.Base64}"
		: null;

	private class ImageViewModel
	{
		public string? Base64 { get; set; }
		public string? TipoImagen { get; set; }
		public string? NombreImagen { get; set; }
	}

	public Task Cancelar()
	{
		navigationManager.NavigateTo($"/fire-force/personal/cobradores", true);
		return Task.CompletedTask;
	}

	public async Task BusquedaPorUPN(string upn)
	{
		if (string.IsNullOrWhiteSpace(upn))
		{
			await message.ErrorAsync("El UPN no puede estar vacío.");
			return;
		}

		_debounceTokenSource?.Cancel();
		_debounceTokenSource = new CancellationTokenSource();
		var token = _debounceTokenSource.Token;

		try
		{
			isLoading = true;

			StateHasChanged();

			await Task.Delay(500, token); // debounce

			var (bombero, foto) = await EntraIDService.BuscarPorUPNAsync(upn, token);

			if (bombero == null)
			{
				await message.ErrorAsync($"No se encontró ningún usuario con el UPN '{upn}@bomberoschivilcoy.org.ar'.");
				return;
			}

			personalView.Nombre = bombero.Nombre;
			personalView.Apellido = bombero.Apellido;
			personalView.EntraID = bombero.EntraID;
			personalView.UPN = bombero.UPN;

			if (foto != null)
			{
				if (foto.Datos != null && foto.Formato != null)
				{
					var extension = foto.Formato.Split('/').LastOrDefault() ?? "jpg";
					var nombreImagen = $"foto_{Guid.NewGuid()}.{extension}";

					imageViewModel = new ImageViewModel
					{
						Base64 = Convert.ToBase64String(foto.Datos),
						TipoImagen = foto.Formato,
						NombreImagen = nombreImagen
					};
				}
			}

			message.Success($"Usuario encontrado: {bombero.Nombre} {bombero.Apellido}");
			StateHasChanged();
		}
		catch (Exception ex)
		{
			message.Error($"Error al buscar usuario: {ex.Message}");
		}
		finally
		{
			isLoading = false;
			StateHasChanged();
		}
	}

	protected override async Task OnInitializedAsync()
	{
		isLoading = true;

		try
		{
			EntraIDisDisponbile = await EntraIDService.CheckDisponibilidadAsync();

			if (!EntraIDisDisponbile)
			{
				await message.ErrorAsync("El Servicio de Entra ID no está disponible. Por favor, intente más tarde.");
				navigationManager.NavigateTo($"/fire-force/personal/cobradores", true);
			}
		}
		catch (Exception ex)
		{
			ConsentHandler.HandleException(ex);
			await message.ErrorAsync($"Error: {ex.Message}");
			navigationManager.NavigateTo($"/fire-force/personal/cobradores", true);
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task OnFinish(EditContext editContext)
	{
		isLoading = true;

		try
		{
			if (!EntraIDisDisponbile)
			{
				message.Error("El Servicio de entra id no esta disponible.");
				return;
			}

			// Preparar el objeto Cobrador para enviarlo al servicio
			Cobrador cobrador = new Cobrador()
			{
				// --- Información Personal ---

				Nombre = personalView.Nombre,
				Apellido = personalView.Apellido,
				EntraId = personalView.EntraID,
				UPN = personalView.UPN + "@bomberoschivilcoy.org.ar",
				Documento = personalView.Documento.Value,
				FechaNacimiento = personalView.FechaNacimiento,
				LugarNacimiento = personalView.LugarNacimiento,
				Direccion = personalView.Direccion,
				Sexo = personalView.Sexo.Value,
				GrupoSanguineo = personalView.GrupoSanguineo,

				// --- Información Profesional ---

				Estado = personalView.Estado,
				ZonasAsignadas = personalView.ZonasAsignadas,
				FechaAceptacion = personalView.FechaAceptacion,

				// --- Información de Contacto ---
				Contacto = new Contacto
				{
					TelefonoCel = personalView.TelefonoCel,
					TelefonoFijo = personalView.TelefonoFijo,
					TelefonoLaboral = personalView.TelefonoLaboral,
					Email = personalView.Email
				}
			};

			// Preparar la foto si existe
			Imagen_Personal? foto = null;

			if (imageViewModel.Base64 != null && imageViewModel.TipoImagen != null && imageViewModel.NombreImagen != null)
			{
				foto = new Imagen_Personal
				{
					NombreImagen = imageViewModel.NombreImagen,
					TipoImagen = imageViewModel.TipoImagen,
					Base64Imagen = imageViewModel.Base64
				};
			}

			// Creamos el cobrador
			await CobradorService.CrearCobradorAsync(cobrador, foto);
			message.Success("Se agregó el cobrador.");
			navigationManager.NavigateTo($"/fire-force/personal/cobradores", true);
		}
		catch (Exception ex)
		{
			message.Error($"Error: {ex.Message}");
		}
		finally
		{
			isLoading = false;
		}
	}
}