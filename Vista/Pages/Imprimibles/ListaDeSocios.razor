@*Layout Vacio*@
@layout EmptyLayout

@page "/fire-force/socios/imprimibles/lista-de-socios"
@page "/fire-force/socios/imprimibles/lista-de-socios/{ZonaParam:int}"
@page "/fire-force/socios/imprimibles/lista-de-socios/inactivos/{IncluirInactivos:bool}"
@page "/fire-force/socios/imprimibles/lista-de-socios/{ZonaParam:int}/inactivos/{IncluirInactivos:bool}"

@using Vista.Services
@using Vista.Data.Models.Socios
@using Vista.Data.Enums.Socios
@using System.ComponentModel.DataAnnotations
@using Microsoft.JSInterop

@inject ISocioService SocioService
@inject IJSRuntime JSRuntime

<PageTitle>Lista de Socios - Bomberos Voluntarios de Chivilcoy</PageTitle>

<style>
    :root {
        --black: #000000;
        --dark-gray: #1a1a1a;
        --medium-gray: #4a4a4a;
        --light-gray: #777777;
        --border-gray: #333333;
        --bg-light: #f5f5f5;
        --white: #FFFFFF;
    }

    body {
        font-family: 'Times New Roman', Times, Georgia, serif;
        font-size: 11pt;
        line-height: 1.4;
        color: var(--black);
        background: var(--white);
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        margin: 0;
        padding: 0;
    }

    #pdf-content {
        width: 190mm;
        margin: 0 auto;
        padding: 10px;
        background: var(--white);
    }

    .header {
        text-align: center;
        padding-bottom: 15px;
        border-bottom: 3px double var(--black);
        margin-bottom: 15px;
    }

    .header-logo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 25px;
        margin-bottom: 10px;
    }

    .logo-icon {
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: grayscale(100%);
    }

    .header-title h1 {
        font-size: 26pt;
        font-weight: 700;
        color: var(--black);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 8px;
    }

    .header-title h2 {
        font-size: 14pt;
        font-weight: 400;
        color: var(--dark-gray);
        font-style: italic;
    }

    .header-info {
        margin-top: 15px;
        font-size: 10pt;
        color: var(--dark-gray);
        display: flex;
        justify-content: space-between;
        border-top: 1px solid var(--border-gray);
        padding-top: 10px;
    }

    .header-info p {
        margin: 0;
    }

    .title-section {
        background: var(--black);
        color: var(--white);
        padding: 15px 20px;
        margin-bottom: 15px;
        text-align: center;
        border: 2px solid var(--black);
    }

    .title-section h3 {
        font-size: 16pt;
        font-weight: 700;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .title-section .subtitle {
        font-size: 12pt;
        font-weight: 400;
        margin-top: 5px;
    }

    .summary-section {
        display: flex;
        justify-content: center;
        gap: 0;
        margin-bottom: 15px;
        padding: 15px 10px;
        border: 2px solid var(--black);
        background: var(--bg-light);
    }

    .summary-item {
        text-align: center;
        padding: 5px 25px;
        border-right: 1px solid var(--border-gray);
        flex: 1;
        max-width: 150px;
    }

    .summary-item:last-child {
        border-right: none;
    }

    .summary-item .number {
        font-size: 22pt;
        font-weight: 700;
        color: var(--black);
        display: block;
        line-height: 1.2;
    }

    .summary-item .label {
        font-size: 8pt;
        color: var(--dark-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 3px;
        display: block;
    }

    .table-container {
        margin-bottom: 15px;
    }

    .pdf-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9pt;
    }

    .pdf-table thead {
        background: var(--black);
        color: var(--white);
    }

    .pdf-table th {
        padding: 10px 6px;
        text-align: left;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 8pt;
        border: 1px solid var(--black);
    }

    .pdf-table tbody tr {
        border-bottom: 1px solid var(--border-gray);
    }

    .pdf-table tbody tr:nth-child(even) {
        background-color: var(--bg-light);
    }

    .pdf-table td {
        padding: 8px 6px;
        vertical-align: middle;
        border-left: 1px solid var(--border-gray);
        border-right: 1px solid var(--border-gray);
    }

    .pdf-table tbody tr:last-child td {
        border-bottom: 2px solid var(--black);
    }

    .socio-number {
        font-weight: 700;
        font-size: 10pt;
    }

    .socio-name {
        font-weight: 600;
    }

    .socio-type {
        display: inline-block;
        padding: 2px 6px;
        font-size: 7pt;
        font-weight: 600;
        text-transform: uppercase;
        border: 1px solid var(--black);
    }

    .socio-type.persona {
        background: var(--white);
    }

    .socio-type.empresa {
        background: var(--bg-light);
    }

    .status-badge {
        display: inline-block;
        padding: 2px 8px;
        font-size: 7pt;
        font-weight: 700;
        text-transform: uppercase;
        border: 2px solid var(--black);
    }

    .status-badge.activo {
        background: var(--white);
    }

    .status-badge.inactivo {
        background: var(--black);
        color: var(--white);
    }

    .status-badge.suspendido {
        background: var(--bg-light);
    }

    .zona-number {
        font-weight: 700;
        font-size: 10pt;
        text-align: center;
        display: inline-block;
        min-width: 25px;
    }

    .cuota-info {
        font-weight: 700;
        text-align: right;
    }

    .contact-info {
        font-size: 8pt;
    }

    .pdf-footer {
        margin-top: auto;
        padding-top: 10px;
        border-top: 3px double var(--black);
    }

    .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        font-size: 9pt;
        color: var(--dark-gray);
    }

    .footer-left {
        text-align: left;
    }

    .footer-left p {
        margin: 3px 0;
    }

    .footer-right {
        text-align: right;
    }

    .document-number {
        font-size: 8pt;
        color: var(--light-gray);
        text-align: center;
        margin-top: 10px;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        gap: 20px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--bg-light);
        border-top-color: var(--black);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        color: var(--dark-gray);
        font-size: 12pt;
    }

    .no-data {
        text-align: center;
        padding: 50px 20px;
        border: 2px solid var(--black);
    }

    .no-data h3 {
        font-size: 14pt;
        margin-bottom: 10px;
    }

    .no-data p {
        color: var(--dark-gray);
    }

    @@media print {
        .action-buttons {
            display: none !important;
        }
    }

    .action-buttons {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1000;
    }

    .action-button {
        background: var(--black);
        color: var(--white);
        border: none;
        padding: 12px 20px;
        font-size: 10pt;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    .action-button:disabled {
        background: var(--medium-gray);
        cursor: not-allowed;
        transform: none;
    }

    .action-button.secondary {
        background: var(--white);
        color: var(--black);
        border: 2px solid var(--black);
    }
</style>

@if (IsLoading)
{
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <p class="loading-text">Cargando lista de socios...</p>
    </div>
}
else if (Socios == null || !Socios.Any())
{
    <div class="no-data">
        <h3>No se encontraron socios</h3>
        <p>@(ZonaParam.HasValue ? $"No hay socios registrados en la Zona {ZonaParam.Value}" : "No hay socios registrados en el sistema")</p>
    </div>
}
else
{
    var sociosOrdenados = Socios.OrderBy(s => s.NroSocio).ToList();
    var totalSocios = Socios.Count;
    var sociosActivos = Socios.Count(s => s.EstadoSocio == TipoEstadoSocio.Activo);
    var sociosInactivos = Socios.Count(s => s.EstadoSocio == TipoEstadoSocio.Inactivo);
    var sociosParaConteo = IncluirInactivos ? Socios : Socios.Where(s => s.EstadoSocio != TipoEstadoSocio.Inactivo);
    var sociosPersonas = sociosParaConteo.Count(s => s.Tipo == Vista.Data.Enums.Discriminadores.TipoSocio.Persona);
    var sociosEmpresas = sociosParaConteo.Count(s => s.Tipo == Vista.Data.Enums.Discriminadores.TipoSocio.Empresa);

    <div id="pdf-content">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">
                <div class="logo-icon">
                    <img src="/Imagenes/Logo.svg" alt="Logo Bomberos Voluntarios de Chivilcoy" />
                </div>
                <div class="header-title">
                    <h1>Bomberos Voluntarios de Chivilcoy</h1>
                    <h2>Asociación Civil - Provincia de Buenos Aires</h2>
                </div>
            </div>
            <div class="header-info">
                <p><strong>Fecha de emisión:</strong> @FechaHoraArgentina.ToString("dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-AR"))</p>
                <p><strong>Hora:</strong> @FechaHoraArgentina.ToString("HH:mm") hs</p>
            </div>
        </header>

        <!-- Title -->
        <div class="title-section">
            <h3>Listado Oficial de Socios</h3>
            <p class="subtitle">@(ZonaParam.HasValue ? $"Zona {ZonaParam.Value}" : "Todas las Zonas")</p>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <div class="summary-item">
                <span class="number">@(IncluirInactivos ? totalSocios : sociosActivos)</span>
                <span class="label">@(IncluirInactivos ? "Total Socios" : "Total Socios Activos")</span>
            </div>
            @if (IncluirInactivos)
            {
                <div class="summary-item">
                    <span class="number">@sociosActivos</span>
                    <span class="label">Activos</span>
                </div>
                <div class="summary-item">
                    <span class="number">@sociosInactivos</span>
                    <span class="label">Inactivos</span>
                </div>
            }
            <div class="summary-item">
                <span class="number">@sociosPersonas</span>
                <span class="label">Personas</span>
            </div>
            <div class="summary-item">
                <span class="number">@sociosEmpresas</span>
                <span class="label">Empresas</span>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table class="pdf-table">
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Nombre / Razón Social</th>
                        <th>DNI/CUIT</th>
                        <th>Tipo</th>
                        <th>Zona</th>
                        <th>Teléfono</th>
                        <th>Dirección</th>
                        <th>Cuota</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var socio in sociosOrdenados)
                    {
                        <tr>
                            <td><span class="socio-number">@socio.NroSocio</span></td>
                            <td>
                                <span class="socio-name">
                                    @if (socio.Tipo == Vista.Data.Enums.Discriminadores.TipoSocio.Persona)
                                    {
                                        @($"{socio.Apellido}, {socio.Nombre}")
                                    }
                                    else
                                    {
                                        @socio.Nombre
                                    }
                                </span>
                            </td>
                            <td>@socio.DocumentoOCUIT</td>
                            <td>
                                <span class="socio-type @(socio.Tipo == Vista.Data.Enums.Discriminadores.TipoSocio.Persona ? "persona" : "empresa")">
                                    @GetEnumDisplayName(socio.Tipo)
                                </span>
                            </td>
                            <td>
                                <span class="zona-number">@GetZonaNumero(socio.Zona)</span>
                            </td>
                            <td class="contact-info">@socio.Telefono</td>
                            <td class="contact-info" title="@socio.Direccion">@TruncateText(socio.Direccion, 20)</td>
                            <td class="cuota-info">$@socio.MontoCuota.ToString("N0")</td>
                            <td>
                                <span class="status-badge @GetEstadoClass(socio.EstadoSocio)">
                                    @GetEnumDisplayName(socio.EstadoSocio)
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <footer class="pdf-footer">
            <div class="footer-content">
                <div class="footer-left">
                    <p><strong>Bomberos Voluntarios de Chivilcoy</strong></p>
                    <p>Documento confidencial - Uso interno</p>
                </div>
                <div class="footer-right">
                    <p>Total de registros: @sociosOrdenados.Count</p>
                </div>
            </div>
            <p class="document-number">
                Ref: SOC-@FechaHoraArgentina.ToString("yyyyMMdd-HHmmss")
            </p>
        </footer>
    </div>

    <!-- Botones de acción -->
    <div class="action-buttons">
        <button class="action-button" @onclick="DescargarPdf" disabled="@IsGenerating">
            @if (IsGenerating)
            {
                <span>Generando...</span>
            }
            else
            {
                <span>?? Descargar PDF</span>
            }
        </button>
        <button class="action-button secondary" @onclick="VistaPrevia" disabled="@IsGenerating">
            <span>??? Vista Previa</span>
        </button>
    </div>
}

@code {
    [Parameter]
    public int? ZonaParam { get; set; }

    [Parameter]
    public bool IncluirInactivos { get; set; } = true;

    private List<Socio>? Socios { get; set; }
    private bool IsLoading { get; set; } = true;
    private bool IsGenerating { get; set; } = false;
    private DateTime FechaHoraArgentina { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var zonaArgentina = TimeZoneInfo.FindSystemTimeZoneById("America/Argentina/Buenos_Aires");
            FechaHoraArgentina = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, zonaArgentina);
        }
        catch
        {
            try
            {
                var zonaArgentina = TimeZoneInfo.FindSystemTimeZoneById("Argentina Standard Time");
                FechaHoraArgentina = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, zonaArgentina);
            }
            catch
            {
                FechaHoraArgentina = DateTime.UtcNow.AddHours(-3);
            }
        }

        await CargarSocios();
    }

    private async Task CargarSocios()
    {
        IsLoading = true;

        try
        {
            var todosSocios = await SocioService.ObtenerSociosAsync();

            if (todosSocios != null)
            {
                var sociosFiltrados = todosSocios.AsEnumerable();

                if (ZonaParam.HasValue)
                {
                    var zonaFiltro = (Zona)ZonaParam.Value;
                    sociosFiltrados = sociosFiltrados.Where(s => s.Zona.HasValue && s.Zona.Value.HasFlag(zonaFiltro));
                }

                if (!IncluirInactivos)
                {
                    sociosFiltrados = sociosFiltrados.Where(s => s.EstadoSocio != TipoEstadoSocio.Inactivo);
                }

                Socios = sociosFiltrados.ToList();
            }
            else
            {
                Socios = new List<Socio>();
            }
        }
        catch (Exception)
        {
            Socios = new List<Socio>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task DescargarPdf()
    {
        IsGenerating = true;
        StateHasChanged();

        try
        {
            await Task.Delay(100); // Pequeño delay para asegurar que el UI se actualice
            var nombreArchivo = $"ListaSocios_{FechaHoraArgentina:yyyyMMdd_HHmmss}.pdf";
            await JSRuntime.InvokeVoidAsync("pdfExport.generatePdf", "pdf-content", nombreArchivo);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al generar PDF: {ex.Message}");
        }
        finally
        {
            IsGenerating = false;
            StateHasChanged();
        }
    }

    private async Task VistaPrevia()
    {
        IsGenerating = true;
        StateHasChanged();

        try
        {
            await Task.Delay(100);
            var nombreArchivo = $"ListaSocios_{FechaHoraArgentina:yyyyMMdd_HHmmss}.pdf";
            await JSRuntime.InvokeVoidAsync("pdfExport.generatePdfWithPreview", "pdf-content", nombreArchivo);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al generar vista previa: {ex.Message}");
        }
        finally
        {
            IsGenerating = false;
            StateHasChanged();
        }
    }

    private string GetEnumDisplayName<TEnum>(TEnum? enumValue) where TEnum : struct, Enum
    {
        if (!enumValue.HasValue) return "-";

        var memberInfo = typeof(TEnum).GetMember(enumValue.Value.ToString()).FirstOrDefault();
        if (memberInfo != null)
        {
            var displayAttribute = memberInfo.GetCustomAttributes(typeof(DisplayAttribute), false).FirstOrDefault() as DisplayAttribute;
            if (displayAttribute != null)
            {
                return displayAttribute.Name ?? enumValue.Value.ToString();
            }
        }
        return enumValue.Value.ToString();
    }

    private string GetZonaNumero(Zona? zona)
    {
        if (!zona.HasValue || zona.Value == Zona.Ninguna)
            return "-";

        var zonas = new List<string>();

        if (zona.Value.HasFlag(Zona.Zona1)) zonas.Add("1");
        if (zona.Value.HasFlag(Zona.Zona2)) zonas.Add("2");
        if (zona.Value.HasFlag(Zona.Zona3)) zonas.Add("3");
        if (zona.Value.HasFlag(Zona.Zona4)) zonas.Add("4");
        if (zona.Value.HasFlag(Zona.Zona5)) zonas.Add("5");

        return zonas.Count > 0 ? string.Join(", ", zonas) : "-";
    }

    private string GetEstadoClass(TipoEstadoSocio? estado)
    {
        return estado switch
        {
            TipoEstadoSocio.Activo => "activo",
            TipoEstadoSocio.Inactivo => "inactivo",
            TipoEstadoSocio.Suspendido => "suspendido",
            _ => ""
        };
    }

    private string TruncateText(string? text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "-";
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }
}
